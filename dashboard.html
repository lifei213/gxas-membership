<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼šå‘˜ä¸­å¿ƒ - å¹¿è¥¿è‡ªåŠ¨åŒ–å­¦ä¼š</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- ECharts for Persona Viz -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <!-- ECharts for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- QRCode.js -->
    <script src="utils/qrcode.min.js"></script>
    <script src="utils/personaGenerator.js"></script>
    <!-- File Parsing Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        /* Fix for chat message layout misalignment */
        .chat-messages {
            display: flex !important;
            flex-direction: column !important;
            gap: 12px !important;
            overflow-y: auto !important;
        }
        .message {
            flex-shrink: 0 !important; /* Prevent collapsing */
            max-width: 85% !important;
            word-wrap: break-word !important;
            position: relative !important; /* Ensure proper stacking context */
        }
        .message.user {
            align-self: flex-end !important;
        }
        .message.ai {
            align-self: flex-start !important;
        }

        /* Contact Admin Modal Beautification */
        .contact-modal-body {
            display: flex;
            flex-direction: column;
            height: 500px;
            max-height: 70vh;
        }

        .chat-history-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8fafc; /* Lighter background */
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-bubble-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 85%;
        }

        .chat-row {
            display: flex;
            width: 100%;
        }

        .chat-row.user {
            justify-content: flex-end;
        }

        .chat-row.admin {
            justify-content: flex-start;
        }

        .chat-bubble {
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.5;
            position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .chat-bubble.user {
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-bubble.admin {
            background: white;
            color: var(--text-main);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }

        .chat-meta {
            font-size: 11px;
            margin-top: 4px;
            opacity: 0.7;
            text-align: right;
        }
        
        .chat-input-wrapper {
            position: relative;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 4px;
            background: white;
            transition: border-color 0.2s;
        }

        .chat-input-wrapper:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .chat-textarea {
            width: 100%;
            border: none;
            resize: none;
            height: 60px;
            padding: 10px;
            font-family: inherit;
            outline: none;
            background: transparent;
        }

        .chat-send-bar {
            display: flex;
            justify-content: flex-end;
            padding: 0 8px 8px;
        }

        .chat-status-tag {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            background: rgba(255,255,255,0.2);
            margin-right: 5px;
            display: inline-block;
        }

        /* Admin Dashboard Beautification */
        .admin-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .admin-card-btn {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 24px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: left;
        }

        .admin-card-btn:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-xl);
            z-index: 10;
        }

        .admin-card-btn .btn-icon {
            font-size: 28px;
            margin-bottom: 16px;
            background: rgba(255, 255, 255, 0.2);
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            backdrop-filter: blur(4px);
        }

        .admin-card-btn .btn-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }

        .admin-card-btn .btn-desc {
            font-size: 13px;
            opacity: 0.9;
            line-height: 1.5;
            font-weight: 400;
        }

        /* Gradient Variants */
        .members-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .applications-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .messages-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        /* Decorative circle */
        .admin-card-btn::after {
            content: '';
            position: absolute;
            top: -20px;
            right: -20px;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container dashboard-container">
        <div class="page-header">
            <div class="system-title">
                å¹¿è¥¿è‡ªåŠ¨åŒ–å­¦ä¼šä¼šå‘˜ç®¡ç†ç³»ç»Ÿ
            </div>
            <div class="page-subtitle" id="page-subtitle">
                ä¼šå‘˜ä¸­å¿ƒ Â· æ¬¢è¿å›æ¥
            </div>
        </div>
        <div id="loading">åŠ è½½ç”¨æˆ·ä¿¡æ¯ä¸­...</div>
        
        <div id="content" style="display: none;">
            <div class="top-right-actions">
                <div class="theme-switch-container">
                    <button class="top-action-btn theme-btn" onclick="toggleThemeMenu()" title="åˆ‡æ¢ä¸»é¢˜">ğŸ¨</button>
                    <div id="theme-menu" class="theme-menu" style="display: none;">
                        <div class="theme-option" onclick="saveTheme('light')">
                            <span class="color-dot" style="background: #10b981;"></span> æµ…è‰²æ¨¡å¼
                        </div>
                        <div class="theme-option" onclick="saveTheme('dark')">
                            <span class="color-dot" style="background: #1e293b;"></span> æ·±è‰²æ¨¡å¼
                        </div>
                        <div class="theme-option" onclick="saveTheme('gxas')">
                            <span class="color-dot" style="background: #059669;"></span> å­¦ä¼šé£æ ¼
                        </div>
                    </div>
                </div>
                <button class="top-action-btn" onclick="window.location.href='forum.html'">ğŸ“š å­¦æœ¯è®ºå›</button>
                <button class="top-action-btn" onclick="openModal('ar-card')">ğŸ“± ARä¼šå‘˜å¡</button>
                <button class="top-action-btn" onclick="openModal('profile')">æŸ¥çœ‹æˆ‘çš„æ¡£æ¡ˆ</button>
                <button class="top-action-btn secondary" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
            
            <div id="profile-card" class="profile-info" style="display: none;">
                <h3>æˆ‘çš„æ¡£æ¡ˆ</h3>
                <p><strong>ä¼šå‘˜ID:</strong> <span id="user-member-code" style="font-family: monospace; letter-spacing: 1px;">-</span></p>
                <p><strong>å§“å:</strong> <span id="user-name">-</span></p>
                <p><strong>é‚®ç®±:</strong> <span id="user-email">-</span></p>
                <p><strong>è§’è‰²:</strong> <span id="user-role">-</span></p>
                <p><strong>ä¼šå‘˜ç­‰çº§:</strong> <span id="user-level">-</span></p>
                <p><strong>èŒåŠ¡:</strong> <span id="user-position">-</span></p>
            </div>

            <!-- AI Persona Card Section -->
            <div id="persona-section" class="persona-card" style="display: none;">
                <div class="persona-header">
                    <div class="persona-avatar">
                        <span>ğŸ§¬</span>
                    </div>
                    <div class="persona-title">
                        <h3>AI æ•°å­—åˆ†èº«</h3>
                        <p>åŸºäºæ‚¨çš„å­¦æœ¯æ´»åŠ¨ä¸è´¡çŒ®å®æ—¶ç”Ÿæˆ</p>
                    </div>
                </div>
                
                <div class="persona-intro" id="persona-intro">
                    ç”Ÿæˆä¸­...
                </div>

                <div class="persona-tags" id="persona-tags">
                    <!-- Tags injected by JS -->
                </div>

                <div class="persona-content-grid" style="display: flex; gap: 20px; align-items: flex-start; margin-top: 20px; flex-wrap: wrap;">
                    <!-- Left: Chart -->
                    <div id="persona-skills" style="flex: 1; height: 300px; min-width: 280px;">
                        <!-- Chart injected by JS -->
                    </div>
                    
                    <!-- Right: Analysis Panel -->
                    <div id="persona-analysis-panel" style="flex: 1; background: var(--bg-secondary); padding: 20px; border-radius: 12px; font-size: 14px; line-height: 1.6; color: var(--text-main); border: 1px solid var(--border-color); min-width: 280px;">
                        <h4 style="margin-top: 0; color: var(--primary-color); display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <span>ğŸ“Š</span> æ´»è·ƒåº¦åˆ†æ
                        </h4>
                        <div id="persona-analysis-text" style="color: var(--text-muted);">
                            æ­£åœ¨åˆ†ææ‚¨çš„å­¦æœ¯è¶³è¿¹...
                        </div>
                    </div>
                </div>
            </div>

            <div id="notifications-section" class="profile-info">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">ğŸ”” é€šçŸ¥æé†’</h3>
                    <button id="contact-admin-btn" class="small" onclick="openModal('contact-admin')" style="width: auto; margin: 0; background-color: #10b981; padding: 6px 12px; font-size: 14px;">ğŸ’¬ è”ç³»ç®¡ç†å‘˜</button>
                </div>
                <ul id="notifications-list" style="padding-left: 18px;"></ul>
            </div>

            <!-- Application Form Section (For Non-Admins) -->
            <div id="application-section" class="profile-info" style="display: none;">
                <h3>ğŸ“ ç”³è¯·æ­£å¼ä¼šå‘˜</h3>
                <p>è¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯ç”³è¯·æˆä¸ºæ­£å¼ä¼šå‘˜æˆ–å­¦ç”Ÿä¼šå‘˜ã€‚</p>
                
                <div id="application-form">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="app-name" placeholder="å§“å" style="flex: 1;">
                        <select id="app-gender" style="width: 100px;">
                            <option value="ç”·">ç”·</option>
                            <option value="å¥³">å¥³</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="app-unit" placeholder="å•ä½/å­¦æ ¡" style="flex: 1;">
                        <input type="text" id="app-phone" placeholder="æ‰‹æœºå·ç " style="flex: 1;">
                    </div>
                    <textarea id="app-reason" placeholder="ç”³è¯·ç†ç”± / ä¸ªäººç®€ä»‹" style="width: 100%; height: 80px; margin-bottom: 10px;"></textarea>
                    
                    <button onclick="submitApplication()">æäº¤ç”³è¯·</button>
                </div>
                
                <div id="application-status" style="display: none; margin-top: 15px; padding: 10px; background-color: #e8f0fe; border-radius: 4px;">
                    <h4>âœ… ç”³è¯·å·²æäº¤</h4>
                    <p>æ‚¨çš„ç”³è¯·çŠ¶æ€ï¼š<strong id="app-status-text">å®¡æ ¸ä¸­</strong></p>
                    <p style="font-size: 14px; color: #666;">å¦‚éœ€åŠ æ€¥ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å‘é€é‚®ä»¶é€šçŸ¥ç®¡ç†å‘˜ã€‚</p>
                    <button class="secondary small" onclick="sendEmailToAdmin()">ğŸ“§ é‚®ä»¶é€šçŸ¥ç®¡ç†å‘˜</button>
                </div>

            </div>

            <!-- Admin Statistics Section -->
            <div id="admin-section" style="display: none;">
                <div class="section-header">ğŸ“Š ä¼šå‘˜ç»Ÿè®¡ (ç®¡ç†å‘˜å¯è§)</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">ğŸ‘¥ æ€»ä¼šå‘˜æ•°</div>
                        <div class="stat-number" id="stat-total">-</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-label">ğŸ’° å·²ç¼´è´¹</div>
                        <div class="stat-number" id="stat-paid">-</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-label">ğŸ“ å­¦ç”Ÿä¼šå‘˜</div>
                        <div class="stat-number" id="stat-student">-</div>
                    </div>
                </div>

                <!-- Admin Action Panel -->
                <div class="admin-actions">
                    <div class="admin-card-btn members-btn" onclick="openModal('members')">
                        <div class="btn-icon">ğŸ‘¥</div>
                        <div class="btn-title">ä¼šå‘˜ç®¡ç† & ç¼´è´¹</div>
                        <div class="btn-desc">ç®¡ç†ä¼šå‘˜æ¡£æ¡ˆã€èŒåŠ¡åŠç¼´è´¹çŠ¶æ€</div>
                    </div>
                    <div class="admin-card-btn applications-btn" onclick="openModal('applications')">
                        <div class="btn-icon">ğŸ“¨</div>
                        <div class="btn-title">å…¥ä¼šç”³è¯·å®¡æ ¸</div>
                        <div class="btn-desc">å®¡æ‰¹æ–°ç”¨æˆ·çš„å…¥ä¼šç”³è¯·</div>
                    </div>
                    <div class="admin-card-btn messages-btn" onclick="openModal('admin-messages')">
                        <div class="btn-icon">ğŸ’¬</div>
                        <div class="btn-title">æ¶ˆæ¯ç®¡ç†</div>
                        <div class="btn-desc">æŸ¥çœ‹å’Œå›å¤ç”¨æˆ·çš„å’¨è¯¢ç•™è¨€</div>
                    </div>
                </div>
            </div>

            <!-- Password Change Button (Bottom Left) -->
            <div class="fixed-bottom-left">
                <button class="admin-action-btn small-btn" onclick="openModal('security')">
                    <span style="margin-right: 5px;">ğŸ”’</span> ä¿®æ”¹å¯†ç 
                </button>
            </div>
            
        </div>
    </div>

    <!-- Modal Overlay -->
    <div id="modal-overlay" class="modal-overlay" style="display: none;" onclick="closeModal(event)">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div id="modal-body">
                <!-- Content injected here -->
            </div>
        </div>
    </div>

    <!-- AR Preview Overlay (Phone Simulator) -->
    <div id="ar-preview-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; justify-content: center; align-items: center; backdrop-filter: blur(8px);">
        <div style="position: relative; width: 360px; height: 680px; background: #000; border-radius: 40px; overflow: hidden; box-shadow: 0 0 60px rgba(16, 185, 129, 0.4); border: 12px solid #2d2d2d;">
            <!-- Notch -->
            <div style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 140px; height: 28px; background: #2d2d2d; border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; z-index: 10;"></div>
            
            <!-- Close Button -->
            <button onclick="closeARPreview()" style="position: absolute; top: 40px; right: 20px; z-index: 20; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px;">Ã—</button>
            
            <iframe id="ar-preview-iframe" style="width: 100%; height: 100%; border: none; background: #000;" src=""></iframe>
        </div>
    </div>

    <!-- Hidden Templates for Modal Content -->
    <div id="template-ar-card" style="display: none;">
        <div class="profile-info" style="text-align: center;">
            <h3>ğŸ“± æ•°å­—ä¼šå‘˜å¡</h3>
            <p>è¯·ä½¿ç”¨æ‰‹æœºæ‰«æä¸‹æ–¹äºŒç»´ç ï¼Œæ¿€æ´»æ‚¨çš„ä¸“å± AR æ¬¢è¿åŠ¨ç”»ã€‚</p>
            <div id="qrcode-container" style="display: flex; justify-content: center; margin: 20px 0;"></div>
            <p style="font-size: 12px; color: var(--text-muted);">
                <a href="#" id="ar-card-link" target="_blank" style="color: var(--primary-color);">ç›´æ¥ç‚¹å‡»æ‰“å¼€ (ç”µè„‘ç«¯é¢„è§ˆ)</a>
            </p>
        </div>
    </div>
    
    <div id="template-security" style="display: none;">
        <div class="profile-info security">
            <h3>ğŸ”’ å®‰å…¨è®¾ç½®</h3>
            <p>å¦‚éœ€ä¿®æ”¹å¯†ç ï¼Œè¯·åœ¨ä¸‹æ–¹è¾“å…¥æ–°å¯†ç å¹¶ä¿å­˜ã€‚</p>
            <div style="display: flex; gap: 10px; max-width: 400px; align-items: center;">
                <input type="password" id="new-password" placeholder="æ–°å¯†ç  (è‡³å°‘6ä½)" style="flex: 1; margin: 0;">
                <button class="small" onclick="handleChangePassword()" style="margin: 0; white-space: nowrap;">ä¿®æ”¹å¯†ç </button>
            </div>
        </div>
    </div>
    
    <div id="template-contact-admin" style="display: none;">
        <div class="contact-modal-body">
            <div class="chat-history-container" id="user-messages-list">
                <div style="text-align: center; color: var(--text-muted); padding: 20px;">åŠ è½½ä¸­...</div>
            </div>
            
            <div class="chat-input-wrapper">
                <textarea id="message-content" class="chat-textarea" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–åé¦ˆ..."></textarea>
                <div class="chat-send-bar">
                    <button onclick="sendMessageToAdmin()" style="margin: 0;">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <div id="template-admin-messages" style="display: none;">
        <div class="member-list">
            <h3>ğŸ’¬ æ¶ˆæ¯ç®¡ç†</h3>
            <table id="admin-messages-table">
                <thead>
                    <tr>
                        <th style="width: 15%;">ç”¨æˆ·</th>
                        <th style="width: 40%;">å†…å®¹</th>
                        <th style="width: 10%;">çŠ¶æ€</th>
                        <th style="width: 15%;">æ—¶é—´</th>
                        <th style="width: 20%;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="admin-messages-tbody">
                    <!-- Rows populated by JS -->
                </tbody>
            </table>
        </div>
    </div>

    <div id="template-profile" style="display: none;">
        <div class="profile-info">
            <h3>æˆ‘çš„æ¡£æ¡ˆ</h3>
            <p><strong>ä¼šå‘˜ID:</strong> <span id="modal-user-member-code" style="font-family: monospace; letter-spacing: 1px;">-</span></p>
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <strong>å§“å:</strong> 
                <span id="modal-user-name">-</span>
                <button class="small secondary" onclick="enableEditName()" id="edit-name-btn">âœï¸ ä¿®æ”¹</button>
                <div id="edit-name-container" style="display: none; align-items: center; gap: 5px;">
                    <input type="text" id="edit-name-input" style="width: 120px; padding: 4px;" placeholder="è¾“å…¥æ–°å§“å">
                    <button class="small" onclick="saveName()">ğŸ’¾ ä¿å­˜</button>
                    <button class="small secondary" onclick="cancelEditName()">âŒ å–æ¶ˆ</button>
                </div>
            </div>
            <p><strong>é‚®ç®±:</strong> <span id="modal-user-email">-</span></p>
            <p><strong>è§’è‰²:</strong> <span id="modal-user-role">-</span></p>
            <p><strong>ä¼šå‘˜ç­‰çº§:</strong> <span id="modal-user-level">-</span></p>
            <p><strong>èŒåŠ¡:</strong> <span id="modal-user-position">-</span></p>
        </div>
    </div>
    <div id="template-members" style="display: none;">
        <div class="member-list">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>ğŸ’° ç¼´è´¹ç®¡ç† & ä¼šå‘˜åˆ—è¡¨</h3>
                <div style="display:flex; gap:8px;">
                    <button class="small" onclick="exportMembersToExcel()">ğŸ“¤ å¯¼å‡º Excel</button>
                    <button class="small" onclick="sendBroadcastReminder()">ğŸ“£ ç¾¤å‘ç«™å†…æé†’</button>
                </div>
            </div>
            <table id="members-table">
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>é‚®ç®±</th>
                        <th>èº«ä»½</th>
                        <th>èŒåŠ¡</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be populated by JS -->
                </tbody>
            </table>
        </div>
    </div>

    <div id="template-applications" style="display: none;">
        <div class="member-list">
            <h3>ğŸ“¨ å…¥ä¼šç”³è¯·å®¡æ ¸</h3>
            <table id="applications-table">
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>å•ä½/å­¦æ ¡</th>
                        <th>ç”µè¯</th>
                        <th>ç”³è¯·ç†ç”±</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be populated by JS -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- AI Assistant HTML -->
    <div class="ai-float-ball" id="aiFloatBall">
        <span>ğŸ¤–</span>
    </div>

    <div class="ai-chat-window" id="aiChatWindow">
        <div class="chat-header">
            <div class="chat-title"><span>ğŸ¤–</span> ç³»ç»ŸåŠ©æ‰‹</div>
            <div class="chat-close" onclick="toggleChat()">Ã—</div>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message ai">ä½ å¥½ï¼æˆ‘æ˜¯ç³»ç»ŸåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ</div>
        </div>
        <div class="chat-input-area">
            <label for="chatFileInput" class="chat-attach-btn" title="å‘é€æ–‡ä»¶" style="display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; cursor: pointer; border-radius: 50%; transition: background 0.2s; margin-right: 4px;">
                <span style="font-size: 20px;">ğŸ“</span>
            </label>
            <input type="file" id="chatFileInput" style="display: none;" onchange="handleChatFileUpload(this)">
            <input type="text" class="chat-input" id="chatInput" placeholder="è¾“å…¥é—®é¢˜..." onkeypress="handleChatKey(event)">
            <button class="chat-send-btn" onclick="sendChat()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script>
        // Global Chat History
        window.chatHistory = [];
        window.lastUploadedFileContent = null;

        // Modal Functions
        function openModal(type) {
            const modal = document.getElementById('modal-overlay');
            const modalBody = document.getElementById('modal-body');
            
            // Clear current content
            modalBody.innerHTML = '';
            
            if (type === 'members') {
                // Clone content from template
                const content = document.getElementById('template-members').innerHTML;
                modalBody.innerHTML = content;
                // Re-attach event listeners or re-render if needed
                // Since we clear tbody on render, we need to trigger render again
                loadAdminStats(); 
            } else if (type === 'applications') {
                const content = document.getElementById('template-applications').innerHTML;
                modalBody.innerHTML = content;
                loadApplications();
            } else if (type === 'profile') {
                const content = document.getElementById('template-profile').innerHTML;
                modalBody.innerHTML = content;
                renderProfileModal();
            } else if (type === 'security') {
                const content = document.getElementById('template-security').innerHTML;
                modalBody.innerHTML = content;
            } else if (type === 'ar-card') {
                const content = document.getElementById('template-ar-card').innerHTML;
                modalBody.innerHTML = content;
                renderARCard();
            } else if (type === 'contact-admin') {
                const content = document.getElementById('template-contact-admin').innerHTML;
                modalBody.innerHTML = content;
                loadUserMessages();
            } else if (type === 'admin-messages') {
                const content = document.getElementById('template-admin-messages').innerHTML;
                modalBody.innerHTML = content;
                loadAdminMessages();
            }
            
            modal.style.display = 'flex';
        }

        function closeModal(event) {
            // If event is provided, check if clicked outside content
            if (event && event.target !== document.getElementById('modal-overlay')) {
                return;
            }
            document.getElementById('modal-overlay').style.display = 'none';
        }

        function renderProfileModal() {
            const p = window.currentProfile || {};
            const s = window.currentSession || {};
            const email = (s && s.user && s.user.email) || p.email || '-';
            document.getElementById('modal-user-member-code').textContent = p.member_code || 'æœªç”Ÿæˆ';
            document.getElementById('modal-user-name').textContent = p.name || 'æœªè®¾ç½®';
            document.getElementById('modal-user-email').textContent = email;
            document.getElementById('modal-user-role').textContent = p.role || 'member';
            document.getElementById('modal-user-level').textContent = p.member_level || 'æ™®é€šä¼šå‘˜';
            document.getElementById('modal-user-position').textContent = p.position || 'ä¼šå‘˜';
        }

        async function renderARCard() {
            let memberCode = '';
            let memberName = 'ä¼šå‘˜';

            try {
                // 1. Try to get from current session/profile first
                if (window.currentProfile && window.currentProfile.member_code) {
                    memberCode = window.currentProfile.member_code;
                    memberName = window.currentProfile.name || 'ä¼šå‘˜';
                } else {
                    // 2. If missing, force fetch from DB
                    console.log("Member code missing in cache, fetching from DB...");
                    const { data: { user } } = await supabaseClient.auth.getUser();
                    if (user) {
                        const { data: profile, error } = await supabaseClient
                            .from('profiles')
                            .select('member_code, name')
                            .eq('id', user.id)
                            .maybeSingle();
                        
                        if (profile) {
                            memberCode = profile.member_code;
                            memberName = profile.name || 'ä¼šå‘˜';
                            // Update cache
                            if (window.currentProfile) {
                                window.currentProfile.member_code = memberCode;
                                window.currentProfile.name = memberName;
                            }
                        }
                    }
                }
            } catch (e) {
                console.error("Error fetching member code for AR card:", e);
            }
            
            console.log("Rendering AR Card. Code:", memberCode, "Name:", memberName);
            
            // Construct URL
            const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
            // Ensure we don't pass 'undefined' or 'null' as string
            const safeCode = memberCode || '';
            const safeName = memberName || 'ä¼šå‘˜';
            
            const cardUrl = `${baseUrl}/member-card.html?name=${encodeURIComponent(safeName)}&code=${encodeURIComponent(safeCode)}`;
            
            console.log("AR Card URL:", cardUrl);
            
            // Update Link behavior to open preview
            const link = document.getElementById('ar-card-link');
            if(link) {
                link.href = "javascript:void(0)";
                link.onclick = (e) => {
                    e.preventDefault();
                    openARPreview(cardUrl);
                };
            }

            // Generate QR Code
            const qrContainer = document.getElementById('qrcode-container');
            if (qrContainer) {
                qrContainer.innerHTML = ''; // Clear previous
                setTimeout(() => {
                    new QRCode(qrContainer, {
                        text: cardUrl,
                        width: 180,
                        height: 180,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                }, 50);
            }
        }

        function openARPreview(url) {
            const overlay = document.getElementById('ar-preview-overlay');
            const iframe = document.getElementById('ar-preview-iframe');
            if(overlay && iframe) {
                iframe.src = url;
                overlay.style.display = 'flex';
                // Close the modal behind it? No, keep it open so user can scan QR too.
            }
        }

        function closeARPreview() {
            const overlay = document.getElementById('ar-preview-overlay');
            const iframe = document.getElementById('ar-preview-iframe');
            if(overlay) {
                overlay.style.display = 'none';
                if(iframe) iframe.src = ''; // Stop video/animation
            }
        }

        // --- Name Edit Logic ---
        function enableEditName() {
            document.getElementById('modal-user-name').style.display = 'none';
            document.getElementById('edit-name-btn').style.display = 'none';
            const container = document.getElementById('edit-name-container');
            container.style.display = 'flex';
            const input = document.getElementById('edit-name-input');
            input.value = window.currentProfile.name || '';
            input.focus();
        }

        function cancelEditName() {
            document.getElementById('modal-user-name').style.display = 'inline';
            document.getElementById('edit-name-btn').style.display = 'inline-block';
            document.getElementById('edit-name-container').style.display = 'none';
        }

        async function saveName() {
            const newName = document.getElementById('edit-name-input').value.trim();
            if (!newName) {
                alert("å§“åä¸èƒ½ä¸ºç©º");
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ name: newName })
                    .eq('id', window.currentProfile.id);

                if (error) throw error;

                // Update Local State
                window.currentProfile.name = newName;
                
                // Update UI
                document.getElementById('modal-user-name').textContent = newName;
                document.getElementById('user-name').textContent = newName; // Main Dashboard Name
                
                // Reset Edit Mode
                cancelEditName();
                
                // Refresh AR Card if user opens it later
                // (AR Card uses window.currentProfile.name, so it will be updated next time it renders)

            } catch (error) {
                console.error("Failed to update name:", error);
                alert("æ›´æ–°å¤±è´¥: " + error.message);
            }
        }

        // --- Persona System Logic ---
        async function updatePersonaSystem(profile) {
            const container = document.getElementById('persona-section');
            if (!container) return;
            container.style.display = 'block';

            try {
                // 1. Fetch activities (Real-time data)
                const { data: activities } = await supabaseClient
                    .from('member_activities')
                    .select('*')
                    .eq('member_id', profile.id);

                // 1.1 Fetch Forum Activity (Posts & Comments)
                const { count: postCount } = await supabaseClient
                    .from('posts')
                    .select('*', { count: 'exact', head: true })
                    .eq('author_id', profile.id);

                const { count: commentCount } = await supabaseClient
                    .from('comments')
                    .select('*', { count: 'exact', head: true })
                    .eq('author_id', profile.id);

                const activityMetrics = { 
                    postCount: postCount || 0, 
                    commentCount: commentCount || 0 
                };

                // 2. Generate Data using the Utils class
                const tags = PersonaGenerator.generateTags(profile, activities || []);
                const intro = PersonaGenerator.generateAIIntro(profile, tags);
                const stats = PersonaGenerator.generateStats(profile, activityMetrics);
                const analysis = PersonaGenerator.generateAnalysis(profile, stats, activityMetrics);
                
                // 3. Update Database (Sync generated persona)
                const ai_persona = {
                    tags: tags,
                    intro: intro,
                    stats: stats,
                    analysis: analysis,
                    updated_at: new Date().toISOString()
                };
                
                // Fire and forget update (don't block UI)
                supabaseClient
                    .from('profiles')
                    .update({ 
                        ai_persona: ai_persona,
                        activity_tags: tags,
                        last_updated: new Date().toISOString()
                    })
                    .eq('id', profile.id)
                    .then(({ error }) => {
                        if (error) console.error("Background Persona Sync Failed:", error);
                    });

                // 4. Render UI
                // Update Title with Name
                const titleEl = document.querySelector('.persona-title h3');
                if (titleEl) titleEl.textContent = `${profile.name || 'ç”¨æˆ·'}çš„æ•°å­—åˆ†èº«`;
                
                // Save for theme updates
                window.lastPersonaData = { tags, intro, stats, analysis };
                renderPersonaUI(tags, intro, stats, analysis);

            } catch (error) {
                console.error("Persona System Error:", error);
                // Fallback rendering
                 const tags = PersonaGenerator.generateTags(profile, []);
                 const intro = PersonaGenerator.generateAIIntro(profile, tags);
                 const stats = PersonaGenerator.generateStats(profile);
                 const analysis = "æš‚æ—¶æ— æ³•è·å–æ‚¨çš„å­¦æœ¯æ´»åŠ¨æ•°æ®ï¼Œè¯·ç¨åé‡è¯•ã€‚";
                 
                 window.lastPersonaData = { tags, intro, stats, analysis };
                 renderPersonaUI(tags, intro, stats, analysis);
            }
        }

        function renderPersonaUI(tags, intro, stats, analysis) {
             // Render Tags
            const tagsContainer = document.getElementById('persona-tags');
            if(tagsContainer) {
                tagsContainer.innerHTML = tags.map(tag => `<span class="persona-tag">${tag}</span>`).join('');
            }

            // Render Intro
            const introEl = document.getElementById('persona-intro');
            if(introEl) introEl.textContent = intro;

            // Render Analysis
            const analysisEl = document.getElementById('persona-analysis-text');
            if(analysisEl && analysis) analysisEl.textContent = analysis;

            // Render Chart
            const chartDom = document.getElementById('persona-skills');
            if (!chartDom) return;
            
            // Ensure height
            chartDom.style.height = '300px';

            let myChart = echarts.getInstanceByDom(chartDom);
            if (!myChart) {
                myChart = echarts.init(chartDom);
                window.personaChartInstance = myChart;
            }
            
            const getVar = (name) => getComputedStyle(document.documentElement).getPropertyValue(name).trim();

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}'
                },
                legend: {
                    show: true,
                    orient: 'vertical',
                    right: 0,
                    top: 'center',
                    data: stats.map(s => s.name),
                    textStyle: { color: getVar('--text-muted') || '#64748b' }
                },
                polar: {
                    radius: ['20%', '80%'],
                    center: ['40%', '50%']
                },
                angleAxis: {
                    max: 100,
                    startAngle: 90,
                    show: false
                },
                radiusAxis: {
                    type: 'category',
                    data: stats.map(s => s.name),
                    axisLine: { show: false },
                    axisTick: { show: false },
                    axisLabel: { show: false },
                    z: 10
                },
                series: [
                    {
                        type: 'bar',
                        data: stats.map(s => ({
                            value: s.value,
                            itemStyle: {
                                color: s.color,
                                borderRadius: [10, 10, 10, 10]
                            }
                        })),
                        coordinateSystem: 'polar',
                        barWidth: 12,
                        roundCap: true,
                        showBackground: true,
                        backgroundStyle: {
                            color: getVar('--bg-secondary') || '#f1f5f9'
                        },
                        animationDuration: 1500,
                        animationEasing: 'cubicOut'
                    }
                ]
            };
            
            myChart.setOption(option);
            
            // Remove old listener to avoid duplicates
            if (window.resizeHandler) window.removeEventListener('resize', window.resizeHandler);
            window.resizeHandler = () => myChart.resize();
            window.addEventListener('resize', window.resizeHandler);
        }
        // --- End Persona System Logic ---

        // 3. Preset Themes (V1.0)
        const THEMES = {
            light: {
                "--primary-color": "#10b981",
                "--bg-color": "#f1f5f9",
                "--bg-gradient": "linear-gradient(135deg, #f0fdf4, #f8fafc)",
                "--header-bg": "linear-gradient(to right, rgba(16,185,129,0.05), transparent)",
                "--card-bg": "#ffffff",
                "--text-main": "#1e293b",
                "--text-muted": "#64748b",
                "--border-color": "#e2e8f0",
                "--input-bg": "#f8fafc",
                "--bg-secondary": "#f8fafc",
                "--hover-bg": "#f1f5f9",
                "--tag-bg": "#f0fdf4",
                "--tag-color": "#10b981",
                "--chat-ai-bg": "#ffffff",
                "--scrollbar-thumb": "#cbd5e1",
                "--scrollbar-track": "#f1f5f9",
                "--logo-gradient": "linear-gradient(135deg, #10b981, #059669)",
                "--btn-gradient": "linear-gradient(135deg, #10b981, #059669)"
            },
            dark: {
                "--primary-color": "#22c55e",
                "--bg-color": "#020617",
                "--bg-gradient": "linear-gradient(135deg, #020617, #0f172a)",
                "--header-bg": "linear-gradient(to right, rgba(34,197,94,0.1), transparent)",
                "--card-bg": "#0f172a",
                "--text-main": "#e2e8f0",
                "--text-muted": "#94a3b8",
                "--border-color": "#1e293b",
                "--input-bg": "#1e293b",
                "--bg-secondary": "#1e293b",
                "--hover-bg": "#334155",
                "--tag-bg": "rgba(34, 197, 94, 0.2)",
                "--tag-color": "#22c55e",
                "--chat-ai-bg": "#1e293b",
                "--scrollbar-thumb": "#475569",
                "--scrollbar-track": "#0f172a",
                "--logo-gradient": "linear-gradient(135deg, #22c55e, #15803d)",
                "--btn-gradient": "linear-gradient(135deg, #22c55e, #16a34a)"
            },
            gxas: { // è‡ªåŠ¨åŒ–å­¦ä¼šé£æ ¼
                "--primary-color": "#059669",
                "--bg-color": "#ecfdf5",
                "--bg-gradient": "linear-gradient(135deg, #ecfdf5, #d1fae5)",
                "--header-bg": "linear-gradient(to right, rgba(5,150,105,0.1), transparent)",
                "--card-bg": "#ffffff",
                "--text-main": "#064e3b",
                "--text-muted": "#047857",
                "--border-color": "#a7f3d0",
                "--input-bg": "#f0fdf4",
                "--bg-secondary": "#d1fae5",
                "--hover-bg": "#d1fae5",
                "--tag-bg": "#d1fae5",
                "--tag-color": "#059669",
                "--chat-ai-bg": "#ffffff",
                "--scrollbar-thumb": "#6ee7b7",
                "--scrollbar-track": "#ecfdf5",
                "--logo-gradient": "linear-gradient(135deg, #059669, #047857)",
                "--btn-gradient": "linear-gradient(135deg, #059669, #047857)"
            }
        };

        // 4. Core Theme Application Algorithm
        function applyTheme(theme) {
            if (!theme) return;
            try {
                // Determine which preset to use
                const mode = theme.mode || 'light';
                const preset = THEMES[mode] || THEMES['light'];

                // Merge: Preset values + Custom overrides (if any)
                // Note: The DB 'theme' object might contain direct overrides like 'primaryColor'
                // We map legacy DB fields to CSS variables if needed, or rely on direct mapping if DB stores them.
                // Assuming 'theme' from DB is { mode: "light", primaryColor: "..." }
                
                const themeConfig = { ...preset };
                
                // Allow specific overrides from DB if keys match CSS variables, 
                // or map known legacy keys (like primaryColor -> --primary-color)
                if (theme.primaryColor) themeConfig['--primary-color'] = theme.primaryColor;
                if (theme.fontSize) document.body.style.fontSize = theme.fontSize;

                // Core Algorithm: Apply all CSS variables
                Object.entries(themeConfig).forEach(([key, value]) => {
                    document.documentElement.style.setProperty(key, value);
                });

            } catch (e) {
                console.warn('Failed to apply theme:', e);
            }
        }

        // --- Theme Logic ---
        
        function toggleThemeMenu() {
            const menu = document.getElementById('theme-menu');
            if (menu.style.display === 'none') {
                menu.style.display = 'block';
                // Close menu when clicking outside
                document.addEventListener('click', closeThemeMenuOnClickOutside);
            } else {
                menu.style.display = 'none';
                document.removeEventListener('click', closeThemeMenuOnClickOutside);
            }
        }

        function closeThemeMenuOnClickOutside(e) {
            const container = document.querySelector('.theme-switch-container');
            if (!container.contains(e.target)) {
                document.getElementById('theme-menu').style.display = 'none';
                document.removeEventListener('click', closeThemeMenuOnClickOutside);
            }
        }

        function updateChartsTheme() {
            // Update main persona chart if data exists
            if (window.lastPersonaData) {
                renderPersonaUI(window.lastPersonaData.tags, window.lastPersonaData.intro, window.lastPersonaData.stats, window.lastPersonaData.analysis);
            }
        }

        async function saveTheme(mode) {
            // Hide menu after selection
            document.getElementById('theme-menu').style.display = 'none';
            document.removeEventListener('click', closeThemeMenuOnClickOutside);

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const newTheme = {
                    mode: mode,
                };

                // 1. Apply immediately for instant feedback
                applyTheme(newTheme);
                
                // Update charts to match new theme
                updateChartsTheme();

                // 2. Persist to DB
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ theme: newTheme })
                    .eq('id', user.id);

                if (error) throw error;
                
                // Update local profile cache
                if (window.currentProfile) {
                    window.currentProfile.theme = newTheme;
                }

                // Optional: Show feedback
                // alert('ä¸»é¢˜å·²æ›´æ–°'); 

            } catch (error) {
                console.error("Failed to save theme:", error);
                alert("ä¸»é¢˜ä¿å­˜å¤±è´¥: " + error.message);
            }
        }



        // --- Message System Logic ---

        async function sendMessageToAdmin() {
            const content = document.getElementById('message-content').value.trim();
            if (!content) {
                alert("è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹");
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('contact_messages')
                    .insert([{ 
                        content: content,
                        user_id: window.currentProfile.id 
                    }]);

                if (error) throw error;

                document.getElementById('message-content').value = '';
                loadUserMessages(); // Refresh list
                alert("æ¶ˆæ¯å·²å‘é€");
            } catch (error) {
                console.error("Failed to send message:", error);
                alert("å‘é€å¤±è´¥: " + error.message);
            }
        }

        async function loadUserMessages() {
            const list = document.getElementById('user-messages-list');
            if (!list) return;

            try {
                const { data, error } = await supabaseClient
                    .from('contact_messages')
                    .select('*')
                    .eq('user_id', window.currentProfile.id)
                    .order('created_at', { ascending: false }); // Get newest first

                if (error) throw error;

                if (!data || data.length === 0) {
                    list.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">æš‚æ— æ¶ˆæ¯è®°å½•</div>';
                    return;
                }

                // Reverse to show oldest at top, newest at bottom
                const sortedData = data.reverse();

                list.innerHTML = sortedData.map(msg => {
                    // User Message
                    let html = `
                        <div class="chat-row user">
                            <div class="chat-bubble-wrapper">
                                <div class="chat-bubble user">
                                    ${msg.content}
                                </div>
                                <div class="chat-meta">
                                    ${new Date(msg.created_at).toLocaleString()} 
                                    ${msg.status === 'replied' ? 'âœ…' : (msg.status === 'read' ? 'ğŸ‘€' : 'â³')}
                                </div>
                            </div>
                        </div>
                    `;

                    // Admin Reply
                    if (msg.reply_content) {
                        html += `
                            <div class="chat-row admin">
                                <div class="chat-bubble-wrapper">
                                    <div class="chat-bubble admin">
                                        ${msg.reply_content}
                                    </div>
                                    <div class="chat-meta">
                                        ç®¡ç†å‘˜ Â· ${new Date(msg.reply_at).toLocaleString()}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    return html;
                }).join('');

                // Scroll to bottom
                setTimeout(() => {
                    list.scrollTop = list.scrollHeight;
                }, 100);

            } catch (error) {
                console.error("Failed to load messages:", error);
                list.innerHTML = '<div style="text-align: center; color: red;">åŠ è½½å¤±è´¥</div>';
            }
        }

        async function loadAdminMessages() {
            const tbody = document.getElementById('admin-messages-tbody');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">åŠ è½½ä¸­...</td></tr>';

            try {
                // Join with profiles to get sender name
                const { data, error } = await supabaseClient
                    .from('contact_messages')
                    .select('*, profiles(name, email)')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">æš‚æ— æ¶ˆæ¯</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map(msg => `
                    <tr style="background: ${msg.status === 'unread' ? 'var(--bg-secondary)' : 'transparent'};">
                        <td>
                            <div>${msg.profiles?.name || 'æœªçŸ¥ç”¨æˆ·'}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">${msg.profiles?.email || ''}</div>
                        </td>
                        <td>
                            <div style="max-height: 60px; overflow-y: auto;">${msg.content}</div>
                            ${msg.reply_content ? `<div style="font-size: 12px; color: var(--primary-color); margin-top: 4px;">å›å¤: ${msg.reply_content}</div>` : ''}
                        </td>
                        <td>
                            <span style="font-size: 12px; padding: 2px 6px; border-radius: 4px; background: ${msg.status === 'unread' ? '#fee2e2' : (msg.status === 'replied' ? 'var(--tag-bg)' : '#f3f4f6')}; color: ${msg.status === 'unread' ? '#ef4444' : (msg.status === 'replied' ? 'var(--tag-color)' : '#6b7280')};">
                                ${msg.status === 'replied' ? 'å·²å›å¤' : (msg.status === 'unread' ? 'æœªè¯»' : 'å·²è¯»')}
                            </span>
                        </td>
                        <td style="font-size: 12px;">${new Date(msg.created_at).toLocaleString()}</td>
                        <td>
                            ${msg.status !== 'replied' ? `
                                <button class="small" onclick="openReplyModal('${msg.id}')">å›å¤</button>
                                ${msg.status === 'unread' ? `<button class="small secondary" onclick="markMessageRead('${msg.id}')">æ ‡ä¸ºå·²è¯»</button>` : ''}
                            ` : '<span style="color: var(--text-muted); font-size: 12px;">å·²å®Œç»“</span>'}
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error("Failed to load admin messages:", error);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        async function openReplyModal(msgId) {
            const reply = prompt("è¯·è¾“å…¥å›å¤å†…å®¹:");
            if (reply) {
                try {
                    const { error } = await supabaseClient
                        .from('contact_messages')
                        .update({ 
                            reply_content: reply,
                            reply_at: new Date().toISOString(),
                            status: 'replied'
                        })
                        .eq('id', msgId);

                    if (error) throw error;
                    alert("å›å¤æˆåŠŸ");
                    loadAdminMessages();
                } catch (e) {
                    alert("å›å¤å¤±è´¥: " + e.message);
                }
            }
        }

        async function markMessageRead(msgId) {
            try {
                const { error } = await supabaseClient
                    .from('contact_messages')
                    .update({ status: 'read' })
                    .eq('id', msgId);

                if (error) throw error;
                loadAdminMessages();
            } catch (e) {
                alert("æ“ä½œå¤±è´¥: " + e.message);
            }
        }

        async function initDashboard() {
            try {
                const session = await checkSession();
                const profile = await getUserRole();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                document.getElementById('user-email').textContent = session.user.email;
                if (profile) {
                    window.currentSession = session;
                    window.currentProfile = profile;
                    
                    // Apply User Theme
                    if (profile.theme) {
                        applyTheme(profile.theme);
                    }

                    document.getElementById('user-member-code').textContent = profile.member_code || 'æœªç”Ÿæˆ';
                    document.getElementById('user-name').textContent = profile.name || 'æœªè®¾ç½®';
                    document.getElementById('user-role').textContent = profile.role || 'member';
                    document.getElementById('user-level').textContent = profile.member_level || 'æ™®é€šä¼šå‘˜';
                    document.getElementById('user-position').textContent = profile.position || 'ä¼šå‘˜';
                    await loadNotifications();
                    await subscribeToNotifications();
                    startNotificationsPolling();
                    if (profile.role === 'admin') {
                        const subTitle = document.getElementById('page-subtitle');
                        if (subTitle) subTitle.textContent = 'ç®¡ç†å‘˜æ§åˆ¶å° Â· æ¬¢è¿å›æ¥';
                        document.getElementById('admin-section').style.display = 'block';
                        
                        // Hide "Contact Admin" button for admins
                        const contactBtn = document.getElementById('contact-admin-btn');
                        if (contactBtn) contactBtn.style.display = 'none';

                        loadAdminStats();
                    } else {
                        document.getElementById('application-section').style.display = 'block';
                        // Show Persona for non-admin members
                        document.getElementById('persona-section').style.display = 'block';
                        updatePersonaSystem(profile);
                        checkApplicationStatus();
                    }
                } else {
                    document.getElementById('user-name').textContent = 'Profile not found';
                }
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('reset') === 'true') {
                    alert('è¯·ç«‹å³è®¾ç½®æ‚¨çš„æ–°å¯†ç ï¼');
                    document.getElementById('new-password').focus();
                }
                if (urlParams.get('notice') === '1') {
                    alert('æ‚¨æ”¶åˆ°ç®¡ç†å‘˜é‚®ä»¶æé†’ï¼Œè¯·ç™»å½•å¹¶æŸ¥çœ‹ç³»ç»Ÿé€šçŸ¥ã€‚');
                }
            } catch (e) {
                document.getElementById('loading').textContent = 'ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½æ•°æ®ï¼š' + e.message;
            }
        }

        async function handleChangePassword() {
            const newPassword = document.getElementById('new-password').value;
            if (!newPassword || newPassword.length < 6) {
                alert('å¯†ç é•¿åº¦è‡³å°‘ä¸º 6 ä½');
                return;
            }
            
            try {
                await updateUserPassword(newPassword);
                alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼');
                document.getElementById('new-password').value = '';
                
                // Remove reset flag from URL if present
                const url = new URL(window.location);
                url.searchParams.delete('reset');
                window.history.replaceState({}, '', url);
                
            } catch (error) {
                alert('ä¿®æ”¹å¤±è´¥: ' + error.message);
            }
        }

        async function loadAdminStats() {
            try {
                // Fetch all profiles (RLS policy allows admins to see all)
                const { data: members, error } = await supabaseClient
                    .from('profiles')
                    .select('*');
                
                if (error) throw error;

                // Calculate statistics
                const stats = {
                    total: members.length,
                    paid: members.filter(m => m.fee_paid).length,
                    students: members.filter(m => m.is_student).length
                };

                // Update UI (Stats Cards)
                const statTotal = document.getElementById('stat-total');
                if (statTotal) {
                    statTotal.textContent = stats.total;
                    document.getElementById('stat-paid').textContent = stats.paid;
                    document.getElementById('stat-student').textContent = stats.students;
                }

                // If modal is open and table exists, render table
                // Note: document.getElementById searches the whole document, so it finds elements inside modal
                const tbody = document.querySelector('#members-table tbody');
                if (tbody) {
                    renderMembersTable(members);
                }

            } catch (error) {
                console.error("åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:", error);
                // Optionally show error in UI
            }
        }

        function renderMembersTable(members) {
            const tbody = document.querySelector('#members-table tbody');
            if (!tbody) return; // Guard if table is not in DOM
            
            tbody.innerHTML = ''; // Clear existing

            members.forEach(member => {
                const tr = document.createElement('tr');
                
                // Status Badge
                const statusBadge = member.fee_paid 
                    ? '<span class="badge badge-paid">å·²ç¼´è´¹</span>' 
                    : '<span class="badge badge-unpaid">æœªç¼´è´¹</span>';

                // Action Button
                let actionBtn = '';
                if (!member.fee_paid) {
                    actionBtn = `<button class="small" onclick="markAsPaid('${member.id}')">ç¡®è®¤ç¼´è´¹</button>`;
                } else {
                    actionBtn = `<button class="small paid" disabled>å·²å®Œæˆ</button>`;
                }
                const inappBtn = `<button class="small" style="margin-left:8px" onclick="sendInAppReminder('${member.id}')">å‘é€ç«™å†…æé†’</button>`;

                // Position Select
                const positions = ["ä¼šå‘˜", "ç†äº‹", "å¸¸åŠ¡ç†äº‹", "ç§˜ä¹¦é•¿", "å‰¯ç†äº‹é•¿", "ç†äº‹é•¿"];
                let positionSelect = `<select onchange="updatePosition('${member.id}', this.value)" style="width: 100px;">`;
                positions.forEach(pos => {
                    const selected = (member.position || 'ä¼šå‘˜') === pos ? 'selected' : '';
                    positionSelect += `<option value="${pos}" ${selected}>${pos}</option>`;
                });
                positionSelect += `</select>`;

                tr.innerHTML = `
                    <td>${member.name || '-'}</td>
                    <td>${member.email || '-'}</td>
                    <td>${member.is_student ? 'å­¦ç”Ÿ' : 'æ™®é€šä¼šå‘˜'}</td>
                    <td>${positionSelect}</td>
                    <td>${statusBadge}</td>
                    <td>${actionBtn}${inappBtn}</td>
                `;
                tbody.appendChild(tr);
            });
        }


        async function loadNotifications() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;
                const { data, error } = await supabaseClient
                    .from('notifications')
                    .select('*')
                    .or(`user_id.eq.${user.id},user_id.is.null`)
                    .order('created_at', { ascending: false })
                    .limit(20);
                if (error) throw error;
                renderNotifications(data || []);
            } catch (e) {
                const list = document.getElementById('notifications-list');
                if (list) list.innerHTML = `<li style="color:#d93025;">åŠ è½½é€šçŸ¥å¤±è´¥ï¼š${e.message}</li>`;
            }
        }

        function renderNotifications(items) {
            const list = document.getElementById('notifications-list');
            if (!list) return;
            list.innerHTML = '';
            if (!items || items.length === 0) {
                list.innerHTML = '<div class="notice-empty">æš‚æ— é€šçŸ¥</div>';
                return;
            }
            items.forEach(n => {
                const li = document.createElement('li');
                const title = n.title || 'ç³»ç»Ÿé€šçŸ¥';
                const time = new Date(n.created_at).toLocaleString();
                li.textContent = `${title}ï¼š${n.message}ï¼ˆ${time}ï¼‰`;
                list.appendChild(li);
            });
        }

        async function subscribeToNotifications() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            const channel = supabaseClient.channel('notifications');
            channel.on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications' }, payload => {
                const n = payload.new;
                if (n.user_id === user.id || n.user_id === null) {
                    const list = document.getElementById('notifications-list');
                    if (list) {
                        const li = document.createElement('li');
                        const title = n.title || 'ç³»ç»Ÿé€šçŸ¥';
                        const time = new Date(n.created_at).toLocaleString();
                        li.textContent = `${title}ï¼š${n.message}ï¼ˆ${time}ï¼‰`;
                        list.prepend(li);
                    }
                }
            }).subscribe();
        }

        function startNotificationsPolling() {
            // Fallback: Poll every 15s in case Realtime is not enabled
            setInterval(() => {
                loadNotifications();
            }, 15000);
        }

        async function sendInAppReminder(memberId) {
            showReminderPrompt(memberId, 'ç®¡ç†å‘˜æé†’', 'è¯·è¾“å…¥æé†’å†…å®¹');
        }

        async function sendBroadcastReminder() {
            showReminderPrompt(null, 'ç³»ç»Ÿé€šçŸ¥', 'è¯·è¾“å…¥ç¾¤å‘æé†’å†…å®¹ï¼ˆæ‰€æœ‰ä¼šå‘˜å¯è§ï¼‰');
        }

        function showReminderPrompt(targetUserId, title, placeholder) {
            const body = document.getElementById('modal-body');
            if (!body) return;
            const existing = document.getElementById('reminder-panel');
            if (existing) existing.remove();
            const panel = document.createElement('div');
            panel.id = 'reminder-panel';
            panel.style.margin = '10px 0 16px 0';
            panel.style.padding = '12px';
            panel.style.border = '1px solid #ddd';
            panel.style.borderRadius = '6px';
            panel.style.background = 'var(--card-bg)';
            panel.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
            panel.innerHTML = `
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                    <strong>${title}</strong>
                    <div>
                        <button class="small" id="reminder-send-btn">å‘é€</button>
                        <button class="small secondary" id="reminder-cancel-btn">å–æ¶ˆ</button>
                    </div>
                </div>
                <textarea id="reminder-input" placeholder="${placeholder}" style="width:100%; height:80px;"></textarea>
            `;
            body.prepend(panel);
            window._reminderTargetUserId = targetUserId;
            document.getElementById('reminder-send-btn').onclick = submitReminderPrompt;
            document.getElementById('reminder-cancel-btn').onclick = cancelReminderPrompt;
        }

        async function submitReminderPrompt() {
            const contentEl = document.getElementById('reminder-input');
            if (!contentEl) return;
            const content = contentEl.value.trim();
            if (!content) return;
            try {
                const target = window._reminderTargetUserId || null;
                const title = target ? 'ç®¡ç†å‘˜æé†’' : 'ç³»ç»Ÿé€šçŸ¥';
                const { error } = await supabaseClient
                    .from('notifications')
                    .insert({ user_id: target, title, message: content });
                if (error) throw error;
                cancelReminderPrompt();
                alert(target ? 'ç«™å†…æé†’å·²å‘é€' : 'ç¾¤å‘ç«™å†…æé†’å·²å‘é€');
            } catch (e) {
                alert('å‘é€å¤±è´¥: ' + e.message);
            }
        }

        function cancelReminderPrompt() {
            const panel = document.getElementById('reminder-panel');
            if (panel) panel.remove();
            window._reminderTargetUserId = null;
        }
        async function updatePosition(memberId, newPosition) {
            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ position: newPosition })
                    .eq('id', memberId);

                if (error) throw error;
                
                // Show a small toast or just log it? Alert might be too annoying for every change.
                // But let's confirm to the user.
                console.log(`Updated position for ${memberId} to ${newPosition}`);
                
            } catch (error) {
                console.error("æ›´æ–°èŒåŠ¡å¤±è´¥:", error);
                if (error.code === '42703') {
                    alert('æ›´æ–°å¤±è´¥: æ•°æ®åº“ç¼ºå°‘ position å­—æ®µã€‚\nè¯·è”ç³»ç®¡ç†å‘˜è¿è¡Œ setup.sql è„šæœ¬ã€‚');
                } else {
                    alert('æ›´æ–°èŒåŠ¡å¤±è´¥: ' + error.message);
                }
                // Reload to reset the select to original value
                loadAdminStats();
            }
        }

        async function markAsPaid(memberId) {
            if (!confirm('ç¡®å®šè¦å°†è¯¥ä¼šå‘˜æ ‡è®°ä¸ºâ€œå·²ç¼´è´¹â€å—ï¼Ÿ')) return;

            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ fee_paid: true })
                    .eq('id', memberId);

                if (error) throw error;

                alert('æ“ä½œæˆåŠŸï¼');
                // Reload stats and table
                loadAdminStats();

            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        async function exportMembersToExcel() {
            if (!confirm('ç¡®å®šè¦å¯¼å‡ºæ‰€æœ‰ä¼šå‘˜èµ„æ–™å—ï¼Ÿ')) return;

            try {
                // Fetch all profiles
                const { data: members, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;

                if (!members || members.length === 0) {
                    alert('æš‚æ— ä¼šå‘˜æ•°æ®å¯å¯¼å‡º');
                    return;
                }

                // Prepare data for Excel
                // Map fields to Chinese headers
                const excelData = members.map(m => ({
                    "ç”¨æˆ·ID": m.id,
                    "å§“å": m.name || '-',
                    "é‚®ç®±": m.email || '-', // Note: email might not be in profiles if not synced properly, but we have it in some cases
                    "è§’è‰²": m.role,
                    "èŒåŠ¡": m.position || 'ä¼šå‘˜',
                    "ä¼šå‘˜ç­‰çº§": m.member_level,
                    "æ˜¯å¦å­¦ç”Ÿ": m.is_student ? "æ˜¯" : "å¦",
                    "ç¼´è´¹çŠ¶æ€": m.fee_paid ? "å·²ç¼´è´¹" : "æœªç¼´è´¹",
                    "æ³¨å†Œæ—¶é—´": m.created_at ? new Date(m.created_at).toLocaleDateString() : '-'
                }));

                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "ä¼šå‘˜åˆ—è¡¨");

                // Generate file name with date
                const dateStr = new Date().toISOString().slice(0, 10);
                const fileName = `ä¼šå‘˜åˆ—è¡¨_${dateStr}.xlsx`;

                // Export
                XLSX.writeFile(wb, fileName);
                
            } catch (error) {
                console.error("Export failed:", error);
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }

        // --- Application Logic (User Side) ---

        async function submitApplication() {
            const name = document.getElementById('app-name').value;
            const gender = document.getElementById('app-gender').value;
            const unit = document.getElementById('app-unit').value;
            const phone = document.getElementById('app-phone').value;
            const reason = document.getElementById('app-reason').value;

            if (!name || !unit || !phone) {
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                
                const { error } = await supabaseClient
                    .from('membership_applications')
                    .insert({
                        user_id: user.id,
                        email: user.email,
                        name,
                        gender,
                        unit,
                        phone,
                        reason
                    });

                if (error) throw error;

                alert('ç”³è¯·å·²æäº¤ï¼');
                checkApplicationStatus(); // Refresh status

            } catch (error) {
                alert('æäº¤å¤±è´¥: ' + error.message);
            }
        }

        async function checkApplicationStatus() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data, error } = await supabaseClient
                    .from('membership_applications')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .maybeSingle();

                if (data) {
                    // Hide form, show status
                    document.getElementById('application-form').style.display = 'none';
                    document.getElementById('application-status').style.display = 'block';
                    
                    const statusMap = {
                        'pending': 'å®¡æ ¸ä¸­',
                        'approved': 'å·²é€šè¿‡',
                        'rejected': 'å·²æ‹’ç»'
                    };
                    document.getElementById('app-status-text').textContent = statusMap[data.status] || data.status;
                }
            } catch (error) {
                console.error("Check status failed", error);
            }
        }

        function sendEmailToAdmin() {
            const subject = "å…¥ä¼šç”³è¯·æé†’";
            const body = "ç®¡ç†å‘˜æ‚¨å¥½ï¼Œæˆ‘å·²åœ¨ç³»ç»Ÿä¸­æäº¤äº†å…¥ä¼šç”³è¯·ï¼Œè¯·æŸ¥é˜…å®¡æ ¸ã€‚\n\næˆ‘çš„é‚®ç®±: " + document.getElementById('user-email').textContent;
            const mailtoLink = `mailto:3410923908@qq.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
        }

        // --- Application Review Logic (Admin Side) ---

        async function loadApplications() {
            try {
                const { data, error } = await supabaseClient
                    .from('membership_applications')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const tbody = document.querySelector('#applications-table tbody');
                if (!tbody) return; // Guard

                tbody.innerHTML = '';

                data.forEach(app => {
                    const tr = document.createElement('tr');
                    
                    let actionHtml = '-';
                    if (app.status === 'pending') {
                        actionHtml = `
                            <button class="small" onclick="reviewApplication('${app.id}', 'approved')">é€šè¿‡</button>
                            <button class="small secondary" onclick="reviewApplication('${app.id}', 'rejected')">æ‹’ç»</button>
                        `;
                    }

                    tr.innerHTML = `
                        <td>${app.name}</td>
                        <td>${app.unit}</td>
                        <td>${app.phone}</td>
                        <td>${app.reason}</td>
                        <td>${app.status}</td>
                        <td>${actionHtml}</td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (error) {
                console.error("Load applications failed", error);
            }
        }

        async function reviewApplication(appId, newStatus) {
            if (!confirm(`ç¡®å®šè¦${newStatus === 'approved' ? 'é€šè¿‡' : 'æ‹’ç»'}è¯¥ç”³è¯·å—ï¼Ÿ`)) return;

            try {
                if (newStatus === 'approved') {
                    // Use RPC function for atomic approval and profile update
                    const { error } = await supabaseClient.rpc('approve_application', { app_id: appId });
                    if (error) throw error;
                } else {
                    // Just update status for rejection
                    const { error } = await supabaseClient
                        .from('membership_applications')
                        .update({ status: newStatus })
                        .eq('id', appId);
                    if (error) throw error;
                }

                alert('æ“ä½œæˆåŠŸï¼');
                loadApplications();
                loadAdminStats(); // Refresh stats
                
                // If I am approving my own application (testing scenario), refresh my own profile
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (user) {
                     // Fetch application to check if it was mine
                    const { data: app } = await supabaseClient
                        .from('membership_applications')
                        .select('user_id')
                        .eq('id', appId)
                        .maybeSingle();
                    
                    if (app && app.user_id === user.id) {
                         location.reload(); // Reload to show updated status
                    }
                }

            } catch (error) {
                console.error("Review failed:", error);
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        // AI Assistant Logic
        const ARK_API_KEY = "e70a1849-d992-4a39-b75f-c3af033fee4b";
        const ARK_MODEL = "ep-20251208190154-944k6";

        // Draggable AI Ball Logic
        (function initDraggableBall() {
            const ball = document.getElementById('aiFloatBall');
            if (!ball) return;

            let isDragging = false;
            let dragStartX, dragStartY;
            let ballStartX, ballStartY;
            let hasMoved = false;

            ball.addEventListener('mousedown', function(e) {
                if (e.button !== 0) return; // Only left click
                
                isDragging = true;
                hasMoved = false;
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                
                const rect = ball.getBoundingClientRect();
                ballStartX = rect.left;
                ballStartY = rect.top;
                
                // Set explicit left/top to allow movement
                ball.style.left = ballStartX + 'px';
                ball.style.top = ballStartY + 'px';
                ball.style.right = 'auto';
                ball.style.bottom = 'auto';
                
                ball.style.animation = 'none'; 
                ball.style.cursor = 'grabbing';
                
                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const dx = e.clientX - dragStartX;
                const dy = e.clientY - dragStartY;
                
                if (Math.abs(dx) > 2 || Math.abs(dy) > 2) {
                    hasMoved = true;
                }

                let newLeft = ballStartX + dx;
                let newTop = ballStartY + dy;
                
                // Boundary checks
                const maxLeft = window.innerWidth - ball.offsetWidth;
                const maxTop = window.innerHeight - ball.offsetHeight;
                
                newLeft = Math.max(0, Math.min(newLeft, maxLeft));
                newTop = Math.max(0, Math.min(newTop, maxTop));
                
                ball.style.left = newLeft + 'px';
                ball.style.top = newTop + 'px';
                
                // Update chat window if it's open
                const chatWindow = document.getElementById('aiChatWindow');
                if (chatWindow && chatWindow.classList.contains('active')) {
                    updateChatWindowPosition();
                }
            });

            document.addEventListener('mouseup', function(e) {
                if (!isDragging) return;
                
                isDragging = false;
                ball.style.cursor = 'pointer';
                
                if (!hasMoved) {
                    toggleChat();
                }
            });
        })();

        function updateChatWindowPosition() {
            const ball = document.getElementById('aiFloatBall');
            const chatWindow = document.getElementById('aiChatWindow');
            if (!ball || !chatWindow) return;

            const rect = ball.getBoundingClientRect();
            const chatWidth = 350;
            const chatHeight = 500;
            const gap = 15;

            // Default: Try to put it to the left of the ball, aligned bottom
            let left = rect.left - chatWidth - gap;
            let top = rect.bottom - chatHeight;

            // Check left boundary
            if (left < 10) {
                // Not enough space on left, put it on right
                left = rect.right + gap;
            }
            
            // Check right boundary
            if (left + chatWidth > window.innerWidth) {
                left = window.innerWidth - chatWidth - 10;
            }

            // Check top/bottom boundary
            if (top + chatHeight > window.innerHeight) {
                top = window.innerHeight - chatHeight - 10;
            }
            if (top < 10) {
                top = 10;
            }

            chatWindow.style.left = left + 'px';
            chatWindow.style.top = top + 'px';
            chatWindow.style.right = 'auto';
            chatWindow.style.bottom = 'auto';
        }

        function toggleChat() {
            const chatWindow = document.getElementById('aiChatWindow');
            if (!chatWindow.classList.contains('active')) {
                updateChatWindowPosition();
            }
            chatWindow.classList.toggle('active');
            if (chatWindow.classList.contains('active')) {
                setTimeout(() => document.getElementById('chatInput').focus(), 300);
            }
        }

        function handleChatKey(event) {
            if (event.key === 'Enter') {
                sendChat();
            }
        }

        async function extractFileContent(file, progressCallback) {
            const fileExt = file.name.split('.').pop().toLowerCase();
            
            try {
                if (['txt', 'md', 'csv', 'json', 'js', 'html', 'css', 'sql'].includes(fileExt)) {
                    return await file.text();
                } 
                else if (fileExt === 'pdf') {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                    let fullText = '';
                    
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += `[Page ${i}]\n${pageText}\n\n`;
                    }
                    return fullText;
                }
                else if (['doc', 'docx'].includes(fileExt)) {
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({arrayBuffer: arrayBuffer});
                    return result.value;
                }
                else if (['jpg', 'jpeg', 'png', 'bmp', 'webp'].includes(fileExt)) {
                    if (progressCallback) progressCallback('æ­£åœ¨è¯†åˆ«å›¾ç‰‡æ–‡å­— (åŠ è½½å¼•æ“ä¸­...)...');
                    
                    const result = await Tesseract.recognize(
                        file,
                        'chi_sim+eng', // Chinese Simplified + English
                        {
                            logger: m => {
                                if (m.status === 'recognizing text' && progressCallback) {
                                    progressCallback(`æ­£åœ¨è¯†åˆ«å›¾ç‰‡æ–‡å­—... ${Math.round(m.progress * 100)}%`);
                                }
                            }
                        }
                    );
                    return `[å›¾ç‰‡OCRè¯†åˆ«ç»“æœ]\n${result.data.text}`;
                }
                
                return null; // Unsupported format for text extraction
            } catch (error) {
                console.error("File extraction error:", error);
                return `(Error extracting file content: ${error.message})`;
            }
        }

        async function handleChatFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Reset input so same file can be selected again if needed
            input.value = '';

            // 1. Show uploading status in Chat
            const messagesDiv = document.getElementById('chatMessages');
            const loadingId = 'uploading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message user';
            loadingDiv.id = loadingId;
            loadingDiv.innerHTML = `<div>æ­£åœ¨å‘é€æ–‡ä»¶: ${file.name}... <span class="upload-spinner">â³</span></div>`;
            messagesDiv.appendChild(loadingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            try {
                // 2. Upload to Supabase Storage
                const fileExt = file.name.split('.').pop();
                const userId = window.currentProfile ? window.currentProfile.id : 'guest';
                
                if (userId === 'guest') {
                    loadingDiv.textContent = 'å‘é€å¤±è´¥: è¯·å…ˆç™»å½•åå†ä¸Šä¼ æ–‡ä»¶';
                    loadingDiv.style.backgroundColor = 'var(--error-color)';
                    return;
                }

                const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
                const filePath = `chat-uploads/${userId}/${fileName}`;

                const { data, error } = await supabaseClient
                    .storage
                    .from('chat-files') 
                    .upload(filePath, file);

                if (error) {
                    if (error.message.includes('Bucket not found')) {
                        throw new Error("å­˜å‚¨æ¡¶ 'chat-files' ä¸å­˜åœ¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜åˆ›å»ºã€‚");
                    }
                    throw error;
                }

                // 3. Get Public URL
                const { data: { publicUrl } } = supabaseClient
                    .storage
                    .from('chat-files')
                    .getPublicUrl(filePath);

                // 4. Update Chat UI with Success
                const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExt.toLowerCase());
                
                const successContent = `
                    <div>å·²å‘é€æ–‡ä»¶:</div>
                    <a href="${publicUrl}" target="_blank" style="color: #fff; text-decoration: underline; word-break: break-all;">
                        ${file.name}
                    </a>
                    ${isImage ? `<div style="margin-top:5px;"><img src="${publicUrl}" style="max-width: 100%; border-radius: 8px; cursor: pointer;" onclick="window.open('${publicUrl}')"></div>` : ''}
                `;
                
                loadingDiv.innerHTML = successContent;
                
                // 5. Update History & Notify AI
                // Add user file message to history
                window.chatHistory.push({
                    role: "user",
                    content: `æˆ‘å‘é€äº†ä¸€ä¸ªæ–‡ä»¶ã€‚æ–‡ä»¶å: ${file.name}ã€‚ä¸‹è½½é“¾æ¥: ${publicUrl}`
                });

                // Add AI typing indicator
                const typingId = addTypingIndicator();
                
                // Extract file content
                let extractedContent = '';
                // Note: We process images now too for OCR
                loadingDiv.innerHTML += `<div><small id="${loadingId}-status">(æ­£åœ¨åˆ†ææ–‡ä»¶å†…å®¹...)</small></div>`;
                
                const statusSpan = document.getElementById(`${loadingId}-status`);
                const updateStatus = (msg) => { if(statusSpan) statusSpan.textContent = `(${msg})`; };

                extractedContent = await extractFileContent(file, updateStatus);
                
                // Update UI to remove "analyzing" text or show "analyzed"
                if (statusSpan) statusSpan.remove();

                // Send context to AI
                try {
                    let systemPrompt = `ç”¨æˆ·ä¸Šä¼ äº†ä¸€ä¸ªæ–‡ä»¶ã€‚æ–‡ä»¶å: ${file.name}ã€‚é“¾æ¥: ${publicUrl}ã€‚`;
                    
                    if (extractedContent) {
                        // Truncate if too long (approx 20k chars to be safe with token limits)
                        const maxLength = 20000;
                        if (extractedContent.length > maxLength) {
                            extractedContent = extractedContent.substring(0, maxLength) + "\n...(å†…å®¹è¿‡é•¿å·²æˆªæ–­)...";
                        }
                        
                        // Save to global context for follow-up questions
                        window.lastUploadedFileContent = extractedContent;

                        systemPrompt += `\n\næ–‡ä»¶å†…å®¹å¦‚ä¸‹:\n\`\`\`\n${extractedContent}\n\`\`\`\n\nè¯·åŸºäºä¸Šè¿°æ–‡ä»¶å†…å®¹å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚å¦‚æœå†…å®¹æ˜¯ä¹±ç æˆ–æ— æ³•ç†è§£ï¼Œè¯·å‘ŠçŸ¥ç”¨æˆ·ã€‚`;
                    } else {
                        systemPrompt += `\næœªèƒ½æå–åˆ°æ–‡ä»¶æ–‡æœ¬å†…å®¹ï¼ˆå¯èƒ½æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶æˆ–ä¸æ”¯æŒçš„æ ¼å¼ï¼‰ã€‚è¯·å‘ŠçŸ¥ç”¨æˆ·ä½ æ”¶åˆ°äº†æ–‡ä»¶ï¼Œä½†æ— æ³•è¯»å–å†…å®¹ã€‚`;
                    }

                    const response = await fetch('https://ark.cn-beijing.volces.com/api/v3/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${ARK_API_KEY}`
                        },
                        body: JSON.stringify({
                            model: ARK_MODEL,
                            messages: [
                                { role: "system", content: systemPrompt },
                                ...window.chatHistory.slice(-1)
                            ]
                        })
                    });

                    const apiData = await response.json();
                    removeMessage(typingId);
                    
                    if (apiData.choices && apiData.choices.length > 0) {
                        const aiContent = apiData.choices[0].message.content;
                        addMessage(aiContent, 'ai');
                        // Add AI response to history
                        window.chatHistory.push({
                            role: "assistant",
                            content: aiContent
                        });
                    }
                } catch (aiError) {
                    console.error("AI Response Error:", aiError);
                    removeMessage(typingId);
                }

            } catch (error) {
                console.error("Upload failed:", error);
                loadingDiv.textContent = `å‘é€å¤±è´¥: ${error.message}`;
                loadingDiv.style.backgroundColor = 'var(--error-color)';
            }
        }

        async function sendChat() {
            const input = document.getElementById('chatInput');
            const messagesDiv = document.getElementById('chatMessages');
            const text = input.value.trim();
            
            if (!text) return;
            
            // Add User Message
            addMessage(text, 'user');
            input.value = '';
            
            // Add User Message to History
            window.chatHistory.push({ role: "user", content: text });
            
            // Limit history length
            if (window.chatHistory.length > 20) {
                window.chatHistory = window.chatHistory.slice(-20);
            }

            // Add Typing Indicator
            const typingId = addTypingIndicator();
            
            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Get Context
            const profile = window.currentProfile || {};
            const role = profile.role === 'admin' ? 'ç®¡ç†å‘˜' : (profile.role ? 'æ™®é€šä¼šå‘˜' : 'è®¿å®¢');
            const name = profile.name || 'ç”¨æˆ·';
            
            let systemPrompt = `ä½ æ˜¯ä¸€ä¸ªç®€æ˜“ä¼šå‘˜ç®¡ç†ç³»ç»Ÿçš„æ™ºèƒ½åŠ©æ‰‹ã€‚
å½“å‰ç³»ç»Ÿä¿¡æ¯ï¼š
- ç³»ç»Ÿåç§°ï¼šä¼šå‘˜ç®¡ç†ç³»ç»Ÿ
- æ ¸å¿ƒåŠŸèƒ½ï¼šä¼šå‘˜æ¡£æ¡ˆç®¡ç†ã€ç¼´è´¹çŠ¶æ€è¿½è¸ªã€å…¥ä¼šç”³è¯·å®¡æ ¸ã€‚
- ä½ çš„ç”¨æˆ·ï¼šå½“å‰ç”¨æˆ·æ˜¯ã€${name}ã€‘ï¼Œèº«ä»½æ˜¯ã€${role}ã€‘ã€‚

ç³»ç»Ÿè§„åˆ™ä¸é€»è¾‘ï¼š
1. **ç®¡ç†å‘˜æƒé™**ï¼šå¯ä»¥æŸ¥çœ‹æ‰€æœ‰ä¼šå‘˜æ•°æ®ã€å®¡æ ¸å…¥ä¼šç”³è¯·ï¼ˆé€šè¿‡/æ‹’ç»ï¼‰ã€å¯¼å‡ºExcelã€å‘é€ç¼´è´¹æé†’ã€‚
2. **ç”³è¯·æµç¨‹**ï¼šç”¨æˆ·æ³¨å†Œåéœ€å¡«å†™ç”³è¯·ä¿¡æ¯ -> ç®¡ç†å‘˜åœ¨åå°â€œå…¥ä¼šç”³è¯·å®¡æ ¸â€ä¸­å®¡æ ¸ -> å®¡æ ¸é€šè¿‡åæˆä¸ºæ­£å¼ä¼šå‘˜ã€‚
3. **å¦‚ä½•æˆä¸ºç®¡ç†å‘˜**ï¼šç›®å‰ç³»ç»Ÿä¸æ”¯æŒå‰å°ç”³è¯·ç®¡ç†å‘˜ï¼Œéœ€ç”±æŠ€æœ¯äººå‘˜åœ¨æ•°æ®åº“ç›´æ¥æŒ‡å®šã€‚
4. **æŠ€æœ¯æ ˆ**ï¼šæœ¬ç³»ç»ŸåŸºäº Supabase (åç«¯/æ•°æ®åº“) + åŸç”Ÿ HTML/JS æ„å»ºã€‚

è¯·åŸºäºä»¥ä¸Šä¿¡æ¯å›ç­”ç”¨æˆ·é—®é¢˜ã€‚`;

            // Inject File Context if available
            if (window.lastUploadedFileContent) {
                systemPrompt += `\n\nã€é‡è¦ä¸Šä¸‹æ–‡ã€‘ç”¨æˆ·ä¹‹å‰ä¸Šä¼ äº†æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š\n\`\`\`\n${window.lastUploadedFileContent}\n\`\`\`\nå¦‚æœç”¨æˆ·çš„é—®é¢˜æ˜¯å…³äºæ­¤æ–‡ä»¶çš„ï¼ˆå¦‚â€œç®€è¿°æ–‡ä»¶â€ã€â€œåˆ†ææ•°æ®â€ç­‰ï¼‰ï¼Œè¯·å¿½ç•¥æ‰€æœ‰â€œä»…é™ä¼šå‘˜ç³»ç»Ÿè¯é¢˜â€çš„é™åˆ¶ï¼Œä¼˜å…ˆè¯¦ç»†è§£ç­”æ–‡ä»¶ç›¸å…³é—®é¢˜ã€‚`;
            } else {
                systemPrompt += `\nå¦‚æœç”¨æˆ·è¯¢é—®æœ¬ç³»ç»Ÿæ— å…³çš„é—®é¢˜ï¼Œè¯·ç¤¼è²Œåœ°å°†è¯é¢˜å¼•å›ç³»ç»ŸåŠŸèƒ½ã€‚å›ç­”è¦ç®€çŸ­ã€ä¸“ä¸šã€‚`;
            }

            try {
                const response = await fetch('https://ark.cn-beijing.volces.com/api/v3/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ARK_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: ARK_MODEL,
                        messages: [
                            { role: "system", content: systemPrompt },
                            ...window.chatHistory
                        ]
                    })
                });

                const data = await response.json();
                
                // Remove Typing Indicator
                removeMessage(typingId);
                
                if (data.choices && data.choices.length > 0) {
                    const aiContent = data.choices[0].message.content;
                    addMessage(aiContent, 'ai');
                    // Add AI Message to History
                    window.chatHistory.push({ role: "assistant", content: aiContent });
                } else {
                    console.error('API Error:', data);
                    addMessage("æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å›ç­”è¿™ä¸ªé—®é¢˜ã€‚", 'ai');
                }
            } catch (error) {
                console.error('Network Error:', error);
                removeMessage(typingId);
                addMessage("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®ã€‚", 'ai');
            }
            
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addMessage(text, type) {
            const messagesDiv = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${type}`;
            msgDiv.textContent = text;
            messagesDiv.appendChild(msgDiv);
            return msgDiv;
        }

        function addTypingIndicator() {
            const messagesDiv = document.getElementById('chatMessages');
            const id = 'typing-' + Date.now();
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ai typing-indicator';
            msgDiv.id = id;
            msgDiv.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            messagesDiv.appendChild(msgDiv);
            return id;
        }

        function removeMessage(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // Initialize
        initDashboard();
    </script>
</body>
</html>
