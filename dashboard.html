<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼šå‘˜ä¸­å¿ƒ - å¹¿è¥¿è‡ªåŠ¨åŒ–å­¦ä¼š</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container dashboard-container">
        <h1>æ¬¢è¿å›æ¥</h1>
        <div id="loading">åŠ è½½ç”¨æˆ·ä¿¡æ¯ä¸­...</div>
        
        <div id="content" style="display: none;">
            <p>æ‚¨å·²æˆåŠŸç™»å½•ç³»ç»Ÿã€‚</p>
            <div style="margin: 10px 0 16px 0;">
                <button class="small" onclick="openModal('profile')">æŸ¥çœ‹æˆ‘çš„æ¡£æ¡ˆ</button>
            </div>
            
            <div id="profile-card" class="profile-info" style="display: none;">
                <h3>æˆ‘çš„æ¡£æ¡ˆ</h3>
                <p><strong>å§“å:</strong> <span id="user-name">-</span></p>
                <p><strong>é‚®ç®±:</strong> <span id="user-email">-</span></p>
                <p><strong>è§’è‰²:</strong> <span id="user-role">-</span></p>
                <p><strong>ä¼šå‘˜ç­‰çº§:</strong> <span id="user-level">-</span></p>
                <p><strong>èŒåŠ¡:</strong> <span id="user-position">-</span></p>
            </div>

            <!-- Password Change Section -->
            <div class="profile-info">
                <h3>ğŸ”’ å®‰å…¨è®¾ç½®</h3>
                <p>å¦‚éœ€ä¿®æ”¹å¯†ç ï¼Œè¯·åœ¨ä¸‹æ–¹è¾“å…¥æ–°å¯†ç å¹¶ä¿å­˜ã€‚</p>
                <div style="display: flex; gap: 10px; max-width: 400px;">
                    <input type="password" id="new-password" placeholder="æ–°å¯†ç  (è‡³å°‘6ä½)" style="flex: 1;">
                    <button class="small" onclick="handleChangePassword()">ä¿®æ”¹å¯†ç </button>
                </div>
            </div>

            <div id="notifications-section" class="profile-info">
                <h3>ğŸ”” é€šçŸ¥æé†’</h3>
                <ul id="notifications-list" style="padding-left: 18px;"></ul>
            </div>

            <!-- Application Form Section (For Non-Admins) -->
            <div id="application-section" class="profile-info" style="display: none;">
                <h3>ğŸ“ ç”³è¯·æ­£å¼ä¼šå‘˜</h3>
                <p>è¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯ç”³è¯·æˆä¸ºæ­£å¼ä¼šå‘˜æˆ–å­¦ç”Ÿä¼šå‘˜ã€‚</p>
                
                <div id="application-form">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="app-name" placeholder="å§“å" style="flex: 1;">
                        <select id="app-gender" style="width: 100px;">
                            <option value="ç”·">ç”·</option>
                            <option value="å¥³">å¥³</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="app-unit" placeholder="å•ä½/å­¦æ ¡" style="flex: 1;">
                        <input type="text" id="app-phone" placeholder="æ‰‹æœºå·ç " style="flex: 1;">
                    </div>
                    <textarea id="app-reason" placeholder="ç”³è¯·ç†ç”± / ä¸ªäººç®€ä»‹" style="width: 100%; height: 80px; margin-bottom: 10px;"></textarea>
                    
                    <button onclick="submitApplication()">æäº¤ç”³è¯·</button>
                </div>
                
                <div id="application-status" style="display: none; margin-top: 15px; padding: 10px; background-color: #e8f0fe; border-radius: 4px;">
                    <h4>âœ… ç”³è¯·å·²æäº¤</h4>
                    <p>æ‚¨çš„ç”³è¯·çŠ¶æ€ï¼š<strong id="app-status-text">å®¡æ ¸ä¸­</strong></p>
                    <p style="font-size: 14px; color: #666;">å¦‚éœ€åŠ æ€¥ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å‘é€é‚®ä»¶é€šçŸ¥ç®¡ç†å‘˜ã€‚</p>
                    <button class="secondary small" onclick="sendEmailToAdmin()">ğŸ“§ é‚®ä»¶é€šçŸ¥ç®¡ç†å‘˜</button>
                </div>
            </div>

            <!-- Admin Statistics Section -->
            <div id="admin-section" style="display: none;">
                <h3>ğŸ“Š ä¼šå‘˜ç»Ÿè®¡ (ç®¡ç†å‘˜å¯è§)</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">æ€»ä¼šå‘˜æ•°</div>
                        <div class="stat-number" id="stat-total">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">å·²ç¼´è´¹</div>
                        <div class="stat-number" id="stat-paid">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">å­¦ç”Ÿä¼šå‘˜</div>
                        <div class="stat-number" id="stat-student">-</div>
                    </div>
                </div>

                <!-- Admin Action Buttons -->
                <div class="admin-actions" style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <button class="admin-action-btn" onclick="openModal('members')">
                        <span style="margin-right: 8px;">ğŸ‘¥</span> ä¼šå‘˜ç®¡ç† & ç¼´è´¹
                    </button>
                    <button class="admin-action-btn" onclick="openModal('applications')">
                        <span style="margin-right: 8px;">ğŸ“¨</span> å…¥ä¼šç”³è¯·å®¡æ ¸
                    </button>
                </div>
            </div>

            <button class="secondary" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <!-- Modal Overlay -->
    <div id="modal-overlay" class="modal-overlay" style="display: none;" onclick="closeModal(event)">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div id="modal-body">
                <!-- Content injected here -->
            </div>
        </div>
    </div>

    <!-- Hidden Templates for Modal Content -->
    <div id="template-profile" style="display: none;">
        <div class="profile-info">
            <h3>æˆ‘çš„æ¡£æ¡ˆ</h3>
            <p><strong>å§“å:</strong> <span id="modal-user-name">-</span></p>
            <p><strong>é‚®ç®±:</strong> <span id="modal-user-email">-</span></p>
            <p><strong>è§’è‰²:</strong> <span id="modal-user-role">-</span></p>
            <p><strong>ä¼šå‘˜ç­‰çº§:</strong> <span id="modal-user-level">-</span></p>
            <p><strong>èŒåŠ¡:</strong> <span id="modal-user-position">-</span></p>
        </div>
    </div>
    <div id="template-members" style="display: none;">
        <div class="member-list">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>ğŸ’° ç¼´è´¹ç®¡ç† & ä¼šå‘˜åˆ—è¡¨</h3>
                <div style="display:flex; gap:8px;">
                    <button class="small" onclick="exportMembersToExcel()">ğŸ“¤ å¯¼å‡º Excel</button>
                    <button class="small" onclick="sendBroadcastReminder()">ğŸ“£ ç¾¤å‘ç«™å†…æé†’</button>
                </div>
            </div>
            <table id="members-table">
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>é‚®ç®±</th>
                        <th>èº«ä»½</th>
                        <th>èŒåŠ¡</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be populated by JS -->
                </tbody>
            </table>
        </div>
    </div>

    <div id="template-applications" style="display: none;">
        <div class="member-list">
            <h3>ğŸ“¨ å…¥ä¼šç”³è¯·å®¡æ ¸</h3>
            <table id="applications-table">
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>å•ä½/å­¦æ ¡</th>
                        <th>ç”µè¯</th>
                        <th>ç”³è¯·ç†ç”±</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be populated by JS -->
                </tbody>
            </table>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script>
        // Modal Functions
        function openModal(type) {
            const modal = document.getElementById('modal-overlay');
            const modalBody = document.getElementById('modal-body');
            
            // Clear current content
            modalBody.innerHTML = '';
            
            if (type === 'members') {
                // Clone content from template
                const content = document.getElementById('template-members').innerHTML;
                modalBody.innerHTML = content;
                // Re-attach event listeners or re-render if needed
                // Since we clear tbody on render, we need to trigger render again
                loadAdminStats(); 
            } else if (type === 'applications') {
                const content = document.getElementById('template-applications').innerHTML;
                modalBody.innerHTML = content;
                loadApplications();
            } else if (type === 'profile') {
                const content = document.getElementById('template-profile').innerHTML;
                modalBody.innerHTML = content;
                renderProfileModal();
            }
            
            modal.style.display = 'flex';
        }

        function closeModal(event) {
            // If event is provided, check if clicked outside content
            if (event && event.target !== document.getElementById('modal-overlay')) {
                return;
            }
            document.getElementById('modal-overlay').style.display = 'none';
        }

        function renderProfileModal() {
            const p = window.currentProfile || {};
            const s = window.currentSession || {};
            const email = (s && s.user && s.user.email) || p.email || '-';
            document.getElementById('modal-user-name').textContent = p.name || 'æœªè®¾ç½®';
            document.getElementById('modal-user-email').textContent = email;
            document.getElementById('modal-user-role').textContent = p.role || 'member';
            document.getElementById('modal-user-level').textContent = p.member_level || 'æ™®é€šä¼šå‘˜';
            document.getElementById('modal-user-position').textContent = p.position || 'ä¼šå‘˜';
        }
        async function initDashboard() {
            try {
                const session = await checkSession();
                const profile = await getUserRole();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                document.getElementById('user-email').textContent = session.user.email;
                if (profile) {
                    window.currentSession = session;
                    window.currentProfile = profile;
                    document.getElementById('user-name').textContent = profile.name || 'æœªè®¾ç½®';
                    document.getElementById('user-role').textContent = profile.role || 'member';
                    document.getElementById('user-level').textContent = profile.member_level || 'æ™®é€šä¼šå‘˜';
                    document.getElementById('user-position').textContent = profile.position || 'ä¼šå‘˜';
                    await loadNotifications();
                    await subscribeToNotifications();
                    startNotificationsPolling();
                    if (profile.role === 'admin') {
                        const h1 = document.querySelector('h1');
                        h1.textContent += ' (ç®¡ç†å‘˜)';
                        h1.style.color = '#d93025';
                        document.getElementById('admin-section').style.display = 'block';
                        loadAdminStats();
                    } else {
                        document.getElementById('application-section').style.display = 'block';
                        checkApplicationStatus();
                    }
                } else {
                    document.getElementById('user-name').textContent = 'Profile not found';
                }
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('reset') === 'true') {
                    alert('è¯·ç«‹å³è®¾ç½®æ‚¨çš„æ–°å¯†ç ï¼');
                    document.getElementById('new-password').focus();
                }
                if (urlParams.get('notice') === '1') {
                    alert('æ‚¨æ”¶åˆ°ç®¡ç†å‘˜é‚®ä»¶æé†’ï¼Œè¯·ç™»å½•å¹¶æŸ¥çœ‹ç³»ç»Ÿé€šçŸ¥ã€‚');
                }
            } catch (e) {
                document.getElementById('loading').textContent = 'ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½æ•°æ®ï¼š' + e.message;
            }
        }

        async function handleChangePassword() {
            const newPassword = document.getElementById('new-password').value;
            if (!newPassword || newPassword.length < 6) {
                alert('å¯†ç é•¿åº¦è‡³å°‘ä¸º 6 ä½');
                return;
            }
            
            try {
                await updateUserPassword(newPassword);
                alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼');
                document.getElementById('new-password').value = '';
                
                // Remove reset flag from URL if present
                const url = new URL(window.location);
                url.searchParams.delete('reset');
                window.history.replaceState({}, '', url);
                
            } catch (error) {
                alert('ä¿®æ”¹å¤±è´¥: ' + error.message);
            }
        }

        async function loadAdminStats() {
            try {
                // Fetch all profiles (RLS policy allows admins to see all)
                const { data: members, error } = await supabaseClient
                    .from('profiles')
                    .select('*');
                
                if (error) throw error;

                // Calculate statistics
                const stats = {
                    total: members.length,
                    paid: members.filter(m => m.fee_paid).length,
                    students: members.filter(m => m.is_student).length
                };

                // Update UI (Stats Cards)
                const statTotal = document.getElementById('stat-total');
                if (statTotal) {
                    statTotal.textContent = stats.total;
                    document.getElementById('stat-paid').textContent = stats.paid;
                    document.getElementById('stat-student').textContent = stats.students;
                }

                // If modal is open and table exists, render table
                // Note: document.getElementById searches the whole document, so it finds elements inside modal
                const tbody = document.querySelector('#members-table tbody');
                if (tbody) {
                    renderMembersTable(members);
                }

            } catch (error) {
                console.error("åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:", error);
                // Optionally show error in UI
            }
        }

        function renderMembersTable(members) {
            const tbody = document.querySelector('#members-table tbody');
            if (!tbody) return; // Guard if table is not in DOM
            
            tbody.innerHTML = ''; // Clear existing

            members.forEach(member => {
                const tr = document.createElement('tr');
                
                // Status Badge
                const statusBadge = member.fee_paid 
                    ? '<span class="badge badge-paid">å·²ç¼´è´¹</span>' 
                    : '<span class="badge badge-unpaid">æœªç¼´è´¹</span>';

                // Action Button
                let actionBtn = '';
                if (!member.fee_paid) {
                    actionBtn = `<button class="small" onclick="markAsPaid('${member.id}')">ç¡®è®¤ç¼´è´¹</button>`;
                } else {
                    actionBtn = `<button class="small paid" disabled>å·²å®Œæˆ</button>`;
                }
                const inappBtn = `<button class="small" style="margin-left:8px" onclick="sendInAppReminder('${member.id}')">å‘é€ç«™å†…æé†’</button>`;

                // Position Select
                const positions = ["ä¼šå‘˜", "ç†äº‹", "å¸¸åŠ¡ç†äº‹", "ç§˜ä¹¦é•¿", "å‰¯ç†äº‹é•¿", "ç†äº‹é•¿"];
                let positionSelect = `<select onchange="updatePosition('${member.id}', this.value)" style="width: 100px;">`;
                positions.forEach(pos => {
                    const selected = (member.position || 'ä¼šå‘˜') === pos ? 'selected' : '';
                    positionSelect += `<option value="${pos}" ${selected}>${pos}</option>`;
                });
                positionSelect += `</select>`;

                tr.innerHTML = `
                    <td>${member.name || '-'}</td>
                    <td>${member.email || '-'}</td>
                    <td>${member.is_student ? 'å­¦ç”Ÿ' : 'æ™®é€šä¼šå‘˜'}</td>
                    <td>${positionSelect}</td>
                    <td>${statusBadge}</td>
                    <td>${actionBtn}${inappBtn}</td>
                `;
                tbody.appendChild(tr);
            });
        }


        async function loadNotifications() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                const { data, error } = await supabaseClient
                    .from('notifications')
                    .select('*')
                    .or(`user_id.eq.${user.id},user_id.is.null`)
                    .order('created_at', { ascending: false })
                    .limit(20);
                if (error) throw error;
                renderNotifications(data || []);
            } catch (e) {
                const list = document.getElementById('notifications-list');
                if (list) list.innerHTML = `<li style="color:#d93025;">åŠ è½½é€šçŸ¥å¤±è´¥ï¼š${e.message}</li>`;
            }
        }

        function renderNotifications(items) {
            const list = document.getElementById('notifications-list');
            if (!list) return;
            list.innerHTML = '';
            if (!items || items.length === 0) {
                list.innerHTML = '<li>æš‚æ— é€šçŸ¥</li>';
                return;
            }
            items.forEach(n => {
                const li = document.createElement('li');
                const title = n.title || 'ç³»ç»Ÿé€šçŸ¥';
                const time = new Date(n.created_at).toLocaleString();
                li.textContent = `${title}ï¼š${n.message}ï¼ˆ${time}ï¼‰`;
                list.appendChild(li);
            });
        }

        async function subscribeToNotifications() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            const channel = supabaseClient.channel('notifications');
            channel.on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications' }, payload => {
                const n = payload.new;
                if (n.user_id === user.id || n.user_id === null) {
                    const list = document.getElementById('notifications-list');
                    if (list) {
                        const li = document.createElement('li');
                        const title = n.title || 'ç³»ç»Ÿé€šçŸ¥';
                        const time = new Date(n.created_at).toLocaleString();
                        li.textContent = `${title}ï¼š${n.message}ï¼ˆ${time}ï¼‰`;
                        list.prepend(li);
                    }
                }
            }).subscribe();
        }

        function startNotificationsPolling() {
            // Fallback: Poll every 15s in case Realtime is not enabled
            setInterval(() => {
                loadNotifications();
            }, 15000);
        }

        async function sendInAppReminder(memberId) {
            showReminderPrompt(memberId, 'ç®¡ç†å‘˜æé†’', 'è¯·è¾“å…¥æé†’å†…å®¹');
        }

        async function sendBroadcastReminder() {
            showReminderPrompt(null, 'ç³»ç»Ÿé€šçŸ¥', 'è¯·è¾“å…¥ç¾¤å‘æé†’å†…å®¹ï¼ˆæ‰€æœ‰ä¼šå‘˜å¯è§ï¼‰');
        }

        function showReminderPrompt(targetUserId, title, placeholder) {
            const body = document.getElementById('modal-body');
            if (!body) return;
            const existing = document.getElementById('reminder-panel');
            if (existing) existing.remove();
            const panel = document.createElement('div');
            panel.id = 'reminder-panel';
            panel.style.margin = '10px 0 16px 0';
            panel.style.padding = '12px';
            panel.style.border = '1px solid #ddd';
            panel.style.borderRadius = '6px';
            panel.style.background = '#fff';
            panel.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
            panel.innerHTML = `
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                    <strong>${title}</strong>
                    <div>
                        <button class="small" id="reminder-send-btn">å‘é€</button>
                        <button class="small secondary" id="reminder-cancel-btn">å–æ¶ˆ</button>
                    </div>
                </div>
                <textarea id="reminder-input" placeholder="${placeholder}" style="width:100%; height:80px;"></textarea>
            `;
            body.prepend(panel);
            window._reminderTargetUserId = targetUserId;
            document.getElementById('reminder-send-btn').onclick = submitReminderPrompt;
            document.getElementById('reminder-cancel-btn').onclick = cancelReminderPrompt;
        }

        async function submitReminderPrompt() {
            const contentEl = document.getElementById('reminder-input');
            if (!contentEl) return;
            const content = contentEl.value.trim();
            if (!content) return;
            try {
                const target = window._reminderTargetUserId || null;
                const title = target ? 'ç®¡ç†å‘˜æé†’' : 'ç³»ç»Ÿé€šçŸ¥';
                const { error } = await supabaseClient
                    .from('notifications')
                    .insert({ user_id: target, title, message: content });
                if (error) throw error;
                cancelReminderPrompt();
                alert(target ? 'ç«™å†…æé†’å·²å‘é€' : 'ç¾¤å‘ç«™å†…æé†’å·²å‘é€');
            } catch (e) {
                alert('å‘é€å¤±è´¥: ' + e.message);
            }
        }

        function cancelReminderPrompt() {
            const panel = document.getElementById('reminder-panel');
            if (panel) panel.remove();
            window._reminderTargetUserId = null;
        }
        async function updatePosition(memberId, newPosition) {
            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ position: newPosition })
                    .eq('id', memberId);

                if (error) throw error;
                
                // Show a small toast or just log it? Alert might be too annoying for every change.
                // But let's confirm to the user.
                console.log(`Updated position for ${memberId} to ${newPosition}`);
                
            } catch (error) {
                console.error("æ›´æ–°èŒåŠ¡å¤±è´¥:", error);
                if (error.code === '42703') {
                    alert('æ›´æ–°å¤±è´¥: æ•°æ®åº“ç¼ºå°‘ position å­—æ®µã€‚\nè¯·è”ç³»ç®¡ç†å‘˜è¿è¡Œ add_position_column.sql è„šæœ¬ã€‚');
                } else {
                    alert('æ›´æ–°èŒåŠ¡å¤±è´¥: ' + error.message);
                }
                // Reload to reset the select to original value
                loadAdminStats();
            }
        }

        async function markAsPaid(memberId) {
            if (!confirm('ç¡®å®šè¦å°†è¯¥ä¼šå‘˜æ ‡è®°ä¸ºâ€œå·²ç¼´è´¹â€å—ï¼Ÿ')) return;

            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ fee_paid: true })
                    .eq('id', memberId);

                if (error) throw error;

                alert('æ“ä½œæˆåŠŸï¼');
                // Reload stats and table
                loadAdminStats();

            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        async function exportMembersToExcel() {
            if (!confirm('ç¡®å®šè¦å¯¼å‡ºæ‰€æœ‰ä¼šå‘˜èµ„æ–™å—ï¼Ÿ')) return;

            try {
                // Fetch all profiles
                const { data: members, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;

                if (!members || members.length === 0) {
                    alert('æš‚æ— ä¼šå‘˜æ•°æ®å¯å¯¼å‡º');
                    return;
                }

                // Prepare data for Excel
                // Map fields to Chinese headers
                const excelData = members.map(m => ({
                    "ç”¨æˆ·ID": m.id,
                    "å§“å": m.name || '-',
                    "é‚®ç®±": m.email || '-', // Note: email might not be in profiles if not synced properly, but we have it in some cases
                    "è§’è‰²": m.role,
                    "èŒåŠ¡": m.position || 'ä¼šå‘˜',
                    "ä¼šå‘˜ç­‰çº§": m.member_level,
                    "æ˜¯å¦å­¦ç”Ÿ": m.is_student ? "æ˜¯" : "å¦",
                    "ç¼´è´¹çŠ¶æ€": m.fee_paid ? "å·²ç¼´è´¹" : "æœªç¼´è´¹",
                    "æ³¨å†Œæ—¶é—´": m.created_at ? new Date(m.created_at).toLocaleDateString() : '-'
                }));

                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "ä¼šå‘˜åˆ—è¡¨");

                // Generate file name with date
                const dateStr = new Date().toISOString().slice(0, 10);
                const fileName = `ä¼šå‘˜åˆ—è¡¨_${dateStr}.xlsx`;

                // Export
                XLSX.writeFile(wb, fileName);
                
            } catch (error) {
                console.error("Export failed:", error);
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }

        // --- Application Logic (User Side) ---

        async function submitApplication() {
            const name = document.getElementById('app-name').value;
            const gender = document.getElementById('app-gender').value;
            const unit = document.getElementById('app-unit').value;
            const phone = document.getElementById('app-phone').value;
            const reason = document.getElementById('app-reason').value;

            if (!name || !unit || !phone) {
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                
                const { error } = await supabaseClient
                    .from('membership_applications')
                    .insert({
                        user_id: user.id,
                        email: user.email,
                        name,
                        gender,
                        unit,
                        phone,
                        reason
                    });

                if (error) throw error;

                alert('ç”³è¯·å·²æäº¤ï¼');
                checkApplicationStatus(); // Refresh status

            } catch (error) {
                alert('æäº¤å¤±è´¥: ' + error.message);
            }
        }

        async function checkApplicationStatus() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                const { data, error } = await supabaseClient
                    .from('membership_applications')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .maybeSingle();

                if (data) {
                    // Hide form, show status
                    document.getElementById('application-form').style.display = 'none';
                    document.getElementById('application-status').style.display = 'block';
                    
                    const statusMap = {
                        'pending': 'å®¡æ ¸ä¸­',
                        'approved': 'å·²é€šè¿‡',
                        'rejected': 'å·²æ‹’ç»'
                    };
                    document.getElementById('app-status-text').textContent = statusMap[data.status] || data.status;
                }
            } catch (error) {
                console.error("Check status failed", error);
            }
        }

        function sendEmailToAdmin() {
            const subject = "å…¥ä¼šç”³è¯·æé†’";
            const body = "ç®¡ç†å‘˜æ‚¨å¥½ï¼Œæˆ‘å·²åœ¨ç³»ç»Ÿä¸­æäº¤äº†å…¥ä¼šç”³è¯·ï¼Œè¯·æŸ¥é˜…å®¡æ ¸ã€‚\n\næˆ‘çš„é‚®ç®±: " + document.getElementById('user-email').textContent;
            const mailtoLink = `mailto:3410923908@qq.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
        }

        // --- Application Review Logic (Admin Side) ---

        async function loadApplications() {
            try {
                const { data, error } = await supabaseClient
                    .from('membership_applications')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const tbody = document.querySelector('#applications-table tbody');
                if (!tbody) return; // Guard

                tbody.innerHTML = '';

                data.forEach(app => {
                    const tr = document.createElement('tr');
                    
                    let actionHtml = '-';
                    if (app.status === 'pending') {
                        actionHtml = `
                            <button class="small" onclick="reviewApplication('${app.id}', 'approved')">é€šè¿‡</button>
                            <button class="small secondary" onclick="reviewApplication('${app.id}', 'rejected')">æ‹’ç»</button>
                        `;
                    }

                    tr.innerHTML = `
                        <td>${app.name}</td>
                        <td>${app.unit}</td>
                        <td>${app.phone}</td>
                        <td>${app.reason}</td>
                        <td>${app.status}</td>
                        <td>${actionHtml}</td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (error) {
                console.error("Load applications failed", error);
            }
        }

        async function reviewApplication(appId, newStatus) {
            if (!confirm(`ç¡®å®šè¦${newStatus === 'approved' ? 'é€šè¿‡' : 'æ‹’ç»'}è¯¥ç”³è¯·å—ï¼Ÿ`)) return;

            try {
                if (newStatus === 'approved') {
                    // Use RPC function for atomic approval and profile update
                    const { error } = await supabaseClient.rpc('approve_application', { app_id: appId });
                    if (error) throw error;
                } else {
                    // Just update status for rejection
                    const { error } = await supabaseClient
                        .from('membership_applications')
                        .update({ status: newStatus })
                        .eq('id', appId);
                    if (error) throw error;
                }

                alert('æ“ä½œæˆåŠŸï¼');
                loadApplications();
                loadAdminStats(); // Refresh stats
                
                // If I am approving my own application (testing scenario), refresh my own profile
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (user) {
                     // Fetch application to check if it was mine
                    const { data: app } = await supabaseClient
                        .from('membership_applications')
                        .select('user_id')
                        .eq('id', appId)
                        .maybeSingle();
                    
                    if (app && app.user_id === user.id) {
                         location.reload(); // Reload to show updated status
                    }
                }

            } catch (error) {
                console.error("Review failed:", error);
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        // Initialize
        initDashboard();
    </script>
</body>
</html>
